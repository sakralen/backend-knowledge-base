# Concurrency

## 1. Введение
**Многозадачность** - несколько процессов поочердно исполняются на ЦПУ.

**Многопоточность** - несколько потоков в рамках одного процесса поочердно исполняются на ЦПУ.

**Несколько ядер** - истинный параллелизм. Потоки могут распределяться между ядрами.

Зачем?
- Нет простоя у ЦПУ;
- Производительное использование I/O;
- Higher app responsivness.

Проблемы:
- Гонки, дедлоки, голодание.

##  Thread
Способы создания:
- extends Thread
- implements Runnable
- anonymous Runnable
- lambda Runnable

**Daemon thread** - Демоны не препятствуют остановке, программа завершается не дожидаясь окончания их работы.

Потоки в Java управляются ОС, их иногда называют OS-level threads. Они тяжеловесны. 

## Кэш
Иногда при записи значения из регистров в ОЗУ, ЦПУ сначала кэширует данные до записи в ОЗУ.

У каждого ядра свой кэш (?).

## Happens Before Guarantee
ЦПУ может выполнять независимые инструкции параллельно => инструкции в коде могут выполняться в ином порядке, нежели as-written.

При использовании общего ресура несколькими потоками возможно нарушение семантики их-ха перестановки инструкций.

**volatile** решает проблему видимости - любая запись в поле будет сразу слито в ОЗУ; чтение происходит всегда из ОЗУ (не из кэша).

Все переменные, видимые потоком, где есть **volatile**-переменная, при записи в ОЗУ этой перемнной, тоже записываются в ОЗУ. Так же с чтением.

**Happens Before Guarantee**:
- Если действие x идет перед y в коде программы и эти действия происходят в одном и том же треде, то x happens-before y
- Освобождение монитора happens-before каждый последующий захват того же самого монитора.
- Освобождение монитора happens-before каждый последующий захват того же самого монитора.
- Запись в volatile переменную happens-before каждое последующее чтение той же самой переменной.
- Финальное действие в треде T1 happens-before любое действие в треде T2, которое обнаруживает, что тред T1 завершен.
- Действие запуска треда (Thread.start()) happens-before первое действие в этом треде.
- Если тред T1 прерывает тред T2, то интеррапт happens-before обнаружение интеррапта. Обнаружить интеррапт можно или по исключению InterruptedException, или с помощью вызова Thread.interrupted/Thread.isInterrupted.
- Дефолтная инициализация (0, false или null) при создании переменной happens-before первое действие в каждом треде.

Важно отметить, что отношение happens-before является транзитивным. То есть, если hb(x,y) и hb(y,z), то hb(x,z).

**Cache Coherence** (когерентность кэша) — это механизм процессора, гарантирующий, что любое ядро всегда читает самое актуальное значение из кэша.
