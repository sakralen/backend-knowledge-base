# Spring

## 1. –í–≤–µ–¥–µ–Ω–∏–µ


## 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ü–û


## 3. IoC & DI
**Object Dependencies** (–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±—ä–µ–∫—Ç–∞) - —ç—Ç–æ –¥—Ä—É–≥–∏–µ –æ–±—ä–µ–∫—Ç—ã (—á–∞—â–µ –≤—Å–µ–≥–æ –¥—Ä—É–≥–∏—Ö –∫–ª–∞—Å—Å–æ–≤), —Å –∫–æ—Ç–æ—Ä—ã–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –æ–±—ä–µ–∫—Ç –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Ö —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å.

**Inversion of Control** (IoC - –∏–Ω–≤–µ—Ä—Å–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è) - —ç—Ç–æ –ø—Ä–∏–Ω—Ü–∏–ø –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—É, –∞ –Ω–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—É

–ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∫–æ–¥–∞: —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ —É–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–¥–æ–º –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞, –∞ –Ω–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–º.

**Dependency Injection** (DI - –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π) - —ç—Ç–æ –æ–¥–Ω–∞ –∏–∑ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π –∏–Ω–≤–µ—Ä—Å–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (IoC), –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º –∫–æ—Ç–æ—Ä–æ–π —Å–æ–∑–¥–∞–Ω–∏–µ–º –æ–±—ä–µ–∫—Ç–∞ –∏ –∫–æ–º–ø–æ–Ω–æ–≤–∫–æ–π –µ–≥–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –¥—Ä—É–≥–æ–π –æ–±—ä–µ–∫—Ç (—Ñ—Ä–µ–π–º–≤–æ—Ä–∫).

–§—Ä–µ–π–º–≤–æ—Ä–∫ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏ –≤–Ω–µ–¥—Ä—è–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑:
- –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞;
- –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–µ—Ç–æ–¥–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (—Ñ–∞–±—Ä–∏—á–Ω—ã–π –º–µ—Ç–æ–¥);
- —Å–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞ (—Å–µ—Ç—Ç–µ—Ä—ã).

## 4. IoC Container
**IoC Container** - –æ–±—ä–µ–∫—Ç,–∫–æ—Ç–æ—Ä—ã–π –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞–Ω–∏–µ–º –¥—Ä—É–≥–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ–º –≤ –Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (**DI**).

–Ø–≤–ª—è–µ—Ç—Å—è –∞—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω—ã–º –º–∞—Å—Å–∏–≤–æ–º:
- –∫–ª—é—á - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (—Å—Ç—Ä–æ–∫–∞);
- –∑–Ω–∞—á–µ–Ω–∏–µ - —Å–∞–º –æ–±—ä–µ–∫—Ç.

–¢–∞–∫–æ–π –≤–Ω–µ–¥—Ä—è–µ–º—ã–π –æ–±—ä–µ–∫—Ç –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è **Bean**'–æ–º.

**Bean** - –æ–±—ä–µ–∫—Ç —Å–æ –≤—Å–µ–º–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª —Å–æ–∑–¥–∞–Ω —Å –ø–æ–º–æ—â—å—é **IoC Container**.

**Metadata** - —Å–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç—å –æ–±—ä–µ–∫—Ç–æ–≤ (**Bean Definition**), –∫–æ—Ç–æ—Ä—ã–µ –≥–æ–≤–æ—Ä—è—Ç IoC Container'—É –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å Bean, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –≤–Ω–µ–¥—Ä—è—Ç—å –∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.

–¢–∏–ø—ã Bean Definition:
- XML-based;
- Annotation-based;
- Java-based.

## 5. XML-based Configuration
–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Spring –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã spring-core –∏ spring-context.

–ö–æ—Ä–Ω–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å - **BeanFactory**.

–ë–æ–ª—å—à–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **ApplicationContext**. –ï–≥–æ –∏ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞—é—Ç –ø–æ–¥ IoC Container'–æ–º.

**ClassPathXmlApplicationContext** —Ä–∞–±–æ—Ç–∞–µ—Ç —Å XML-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π. –í –Ω–µ–≥–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø—É—Ç—å –∫ **application.xml**.

–ü—Ä–∏–º–µ—Ä **application.xml**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

    <bean id="pool1" name="p1,p2,p3" class="com.dmdev.spring.database.pool.ConnectionPool"/>
    <bean id="pool2" name="p4" class="com.dmdev.spring.database.pool.ConnectionPool"/>

</beans>
```

class —è–≤–ª—è–µ—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –∞—Ç—Ä–∏–±—É—Ç–æ–º. –ë–µ–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è id –æ–Ω –±—É–¥–µ—Ç –≤—ã—Å—Ç—É–ø–∞—Ç—å –∑–∞ –Ω–µ–≥–æ: com.dmdev.spring.database.pool.ConnectionPool#0.

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.

–í **applicationContext.beanFactory.beanDefinitionMap** –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å –≤—Å–µ Bean'—ã.

–í –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω–æ–º –ø—Ä–∏–º–µ—Ä–µ xml –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –¥–≤–∞ —Å–∏–Ω–≥–ª—Ç–æ–Ω–∞: –µ—Å–ª–∏ –ø–æ–ª—É—á–∏—Ç—å Bean –ø–æ –∫–ª–∞—Å—Å—É, –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞.

## 6. Constructor Injection
–ü—Ä–∏–º–µ—Ä:
```java
public class ConnectionPool {

    private final String username;
    private final Integer poolSize;
    private final List<Object> args;
    private final Map<String, Object> properties;

    public ConnectionPool(String username,
                          Integer poolSize,
                          List<Object> args,
                          Map<String, Object> properties) {
        this.username = username;
        this.poolSize = poolSize;
        this.args = args;
        this.properties = properties;
    }
}
```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

    <bean id="driver" class="java.lang.String">
        <constructor-arg type="java.lang.String" value="PostgresDriver"/>
    </bean>

    <bean id="pool1" name="p1,p2,p3" class="com.dmdev.spring.database.pool.ConnectionPool">
        <constructor-arg name="username" type="java.lang.String" value="postgres"/>
        <constructor-arg name="properties" type="java.util.Map">
            <map>
                <entry key="url" value="postgresurl"/>
                <entry key="password" value="123"/>
            </map>
        </constructor-arg>
        <constructor-arg name="poolSize" type="java.lang.Integer" value="10"/>
        <constructor-arg name="args" type="java.util.List">
            <list>
                <value>--arg1=value1</value>
                <value>--arg2=value2</value>
            </list>
        </constructor-arg>
    </bean>
<!--    <bean id="pool2" name="p4" class="com.dmdev.spring.database.pool.ConnectionPool"/>-->

</beans>
```

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—ç–≥ **index** (–≤ –ø—Ä–∏–Ω—Ü–∏–ø–µ, –Ω–µ –Ω–∞–¥–æ).

–¢–∏–ø—ã —É–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –Ω—É–∂–Ω–æ–≥–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ (–ø—Ä–∏–º–µ—Ä —Å **driver**).

## 7. Factory Method Injection
–ß—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –±–∏–Ω—ã, —Å–ª–µ–¥—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **ref**. –í –º–∞–ø–∞—Ö - **value-ref**, –≤ —Å–ø–∏—Å–∫–∞—Ö  - **\<ref/>**.

–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ–∞–±—Ä–∏—á–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **factory-method="–Ω–∞–∑–≤–∞–Ω–∏–µ"**.

–ï—Å—Ç—å –µ—â–µ **factory-bean** - —á—Ç–æ-—Ç–æ —Ç–∏–ø–∞ —Ñ–∞–±—Ä–∏–∫–∏.

## 8. Property Injection
Setter'—ã —É–±–∏–≤–∞—é—Ç –∏–º–º—É—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å üíÄ.

–î–ª—è Property Injection —Å–ª–µ–¥—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **\<property/>**.

–ü—Ä–∏–º–µ—Ä:
```xml
<property name="properties">
    <map>
        <entry key="url" value="postgresurl"/>
        <entry key="password" value="123"/>
        <entry key="driver" value-ref="driver"/>
    </map>
</property>
```

–°–Ω–∞—á–∞–ª–∞ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã, –ø–æ—Ç–æ–º —Å–µ—Ç—Ç–µ—Ä—ã. –≠—Ç–æ –Ω–∞–º–µ–∫–∞–µ—Ç –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ Bean'–æ–≤. –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç:

Bean definitions -> IoC Container [Sorted Bean Definitions -> For each Bean Definition [Bean constructor called -> Setters called] -> Beans]

Sorted - –æ–¥–Ω–∏ –±–∏–Ω—ã –º–æ–≥—É—Ç –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –¥—Ä—É–≥–∏—Ö -> –Ω—É–∂–µ–Ω –ø–æ—Ä—è–¥–æ–∫ –∏—Ö —Å–æ–∑–¥–∞–Ω–∏—è. 

–¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ —Å–µ—Ç—Ç–µ—Ä—ã, –Ω–æ —ç—Ç–æ bad practice (?).

## 9. Bean Scopes
![Bean Scopes](bean-scopes.png "Bean Scopes")

Bean Scopes
  - Common (ApplicationContext)
    - singleton
    - prototype
    - thread (–∏—Å–ø–æ–ª—å–∑—É—é—Ç ThreadLocal)
  - Web (WebApplicationContext)
    - request
    - session
    - application
    - websocket
  - Custom

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - singleton (–æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä).

prototype - —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑. –í ApplicationContext –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è.

## 10. Lifecycle Callbacks
–£–ª—É—á—à–∞–µ–º Beans Lifecycle:

Bean definitions -> IoC Container [Sorted Bean Definitions -> For each Bean Definition [Bean constructor called -> Setters called -> **Initialization callbacks**] -> Beans -> For each Singleton Bean [**Destruction callbacks**]]

Initialization callbacks:
1. @PostConstruct
2. afterPropertiesSet() - InitializingBean
3. init-method - xml

Destruction callbacks
1. @PreDestroy
2. destroy() - DisposableBean
3. destroy-method - xml

## 11. Injecction from properties
–°–æ–∑–¥–∞–µ–º application.properties. –ö–∞–∂–¥–æ–µ —Å–ª–æ–≤–∞ —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É, –∫-–∑ —á–µ—Ä–µ–∑ —Ä–∞–≤–Ω–æ.

–ü—Ä–∏–º–µ—Ä application.properties:
```properties
db.username=postgres
db.password=pass
db.pool.size=12
db.driver=PostgresDriver
db.url=postgres:5432
db.hosts=localhost
#db.hosts=localhost,127.0.0.1
```

–í application.xml:
```xml
<bean class="org.springframework.context.support.PropertySourcesPlaceholderConfigurer">
    <property name="locations" value="classpath:application.properties"/>
</bean>
```

–õ–∏–±–æ —á–µ—Ä–µ–∑ namespace:
```xml
<context:property-placeholder location="classpath:application.properties"/>
```

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å expression-language —Å –ø–æ–º–æ—â—å—é ${...}:
```xml
<bean id="driver" class="java.lang.String">
    <constructor-arg type="java.lang.String" value="${db.driver}"/>
</bean>
```

–ê –µ—â–µ –µ—Å—Ç—å SpEL (**Sp**ring **E**xpression **L**anguage)!
–ü—Ä–∏–º–µ—Ä:
```xml
<property name="properties">
        <map>
            <entry key="url" value="postgresurl"/>
            <entry key="password" value="123"/>
            <entry key="driver" value="#{driver.substring(3)}"/>
            <entry key="test" value="#{driver.length() > 10}"/>
            <entry key="test1" value="#{driver.length() > T(Math).random() * 10}"/>
            <entry key="hosts" value="#{'${db.hosts}'.split(',')}"/>
            <entry key="currentUser" value="#{systemProperties['user.name']}"/>
            <entry key="currentUser" value="${user.name}"/>
        </map>
</property>
```

## 12. BeanFactoryPostProcessor
–í –∂–∏–∑–Ω–µ–Ω–Ω–æ–º —Ü–∏–∫–ª–µ –±–∏–Ω–æ–≤ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –¥–æ **Sorted Bean Definitions**.

- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è;
- –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è expression language.

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–µ **Visitor**.

–ë–∏–Ω—ã –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –ø–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º –∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É –∫–ª–∞—Å—Å—É. Spring —É–∑–Ω–∞–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ **attributeClass** **BeanDefinition**'–∞ –æ–±—ä–µ–∫—Ç–æ–º —Ç–∏–ø–∞ **BeanFactoryPostProcessor**.

## 13. Custom BeanFactoryPostProcessor
–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å Ordered –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã—Å—Ç–∞–≤–ª—è—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç BFPP.

## 14. Annotation-based Configuration
–ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ **@PostConstruct** –∏ **@PreDestroy** –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ **jakarta.annotation-api**.

–í application.xml –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è:
```xml
 <bean class="org.springframework.context.annotation.CommonAnnotationBeanPostProcessor"/>
```

 –∏–ª–∏:

```xml
 <context:annotation-config/>
```

**annotation-config** –ø–æ–º–∏–º–æ **CommonAnnotationBeanPostProcessor** –¥–æ–±–∞–≤–∏—Ç –µ—â–µ 4 –±–∏–Ω–∞:

1. CommonAnnotationBeanPostProcessor (BeanPostProcessor)
  - @PreDestroy
  - @PostConstruct
  - @Resource
2. AutowiredAnnotationBeanPostProcessor (BeanPostProcessor)
  - @Autowired
  - @Value
3. EventListenerMethodProcessor (BeanFactoryPostProcessor)
  - @EventListener
4. ConfigurationClassPostProcessor (BeanFactoryPostProcessor)
  - @Configuration
5. PresistenceAnnotationBeanPostProcessor (BeanPostProcessor)
  - @PersistenceContext
  - @PersistenceUnit

## 15. BeanPostProcessor
–£ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ **BeanPostProcessor** –¥–≤–∞ –º–µ—Ç–æ–¥–∞:
```java
default Object postProcessBeforeInitialization(Object bean, String beanName) {
    return bean;
}

default Object postProcessAfterInitialization(Object bean, String beanName) {
    return bean;
}
```

**–§–∏–Ω–∞–ª—å–Ω—ã–π –≤–∏–¥ Beans Lifecycle**:
![Bean Lifecycle"](bean-lifecycle.png "Bean Lifecycle")

**@PostConstruct** - —ç—Ç–æ —Ç–æ–∂–µ BPP (?).

–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã-–æ—Å–≤–µ–¥–æ–º–∏—Ç–µ–ª–∏ **Aware** –ø–æ–∑–≤–æ–ª—è—é—Ç inject'–∞—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –±–∏–Ω—ã. –ü—Ä–∏–º–µ—Ä - **ApplicationContextAware**:
```java
public interface ApplicationContextAware extends Aware {
    void setApplicationContext(ApplicationContext applicationContext) throws BeansException;
}
```

Aware-–∫–ª–∞—Å—Å–∞–º–∏ –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è **ApplicationContextAwareProcessor** BPP.

## 16. Custom BeanPostProcessor I
–í Spring –µ—Å—Ç—å **ReflectionUtils** üòè.

## 17. Custom BeanPostProcessor II
–ù–µ —Å—Ç–æ–∏—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –≤ **beforeInit()** –ø—Ä–æ–∫—Å–∏! –¢–æ–≥–¥–∞ init-–∫–æ–ª–ª–±—ç–∫–∏ –ø–æ—Ç–µ—Ä—è—é—Ç –Ω—É–∂–Ω—ã–π –∫–ª–∞—Å—Å! –ü–æ—ç—Ç–æ–º—É —Å–ª–µ–¥—É–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ–∫—Å–∏ –≤ **afterInit()**.  –ê –≤ beforeInit() —Å–æ—Ö—Ä–∞–Ω—è—Ç –∫-–∑ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –±–∏–Ω–∞ –∏ –µ–≥–æ –∏–º–µ–Ω–∏. –ü—Ä–∏–º–µ—Ä:
```java
public class TransactionBeanPostProcessor implements BeanPostProcessor {

    private final Map<String, Class<?>> transactionBeans = new HashMap<>();

    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
        if (bean.getClass().isAnnotationPresent(Transaction.class)) {
            transactionBeans.put(beanName, bean.getClass());
        }
        return bean;
    }

    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
        Class<?> beanClass = transactionBeans.get(beanName);
        if (beanClass != null) {
            return Proxy.newProxyInstance(beanClass.getClassLoader(), beanClass.getInterfaces(),
                    (proxy, method, args) -> {
                        System.out.println("Open transaction");
                        try {
                            return method.invoke(bean, args);
                        } finally {
                            System.out.println("Close transaction");
                        }
                    });
        }
        return bean;
    }
}
```

–†–æ–¥–Ω–æ–π DynamicProxy –∏–∑ java.lang.reflect —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã (–Ω–µ —á–µ—Ä–µ–∑ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ). 

## 18. Autowired & Value
**@Autowired** - –∏–Ω–∂–µ–∫—Ç–∞–µ—Ç –±–∏–Ω—ã. **@Resource** - —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è–µ—Ç Java EE JSR-250. –°–ª–µ–¥—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **@Autowired**.

–ï—Å–ª–∏ –±–∏–Ω–æ–≤-–∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **@Resource(name = "")** –∏–ª–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏—é **@Autowired** –∏ **@Qualifier("")**. **@Autowired** –ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞ —Ç–∏–ø –±–∏–Ω–∞.
–¢–∞–∫–∂–µ –≤–º–µ—Å—Ç–æ **@Qualifier** –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞–∑–≤–∞—Ç—å –ø–æ–ª–µ —Ç–∞–∫ –∂–µ, –∫–∞–∫ –∞–π–¥–∏ –±–∏–Ω–∞.

**@Autowired** –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –Ω–∞–¥ —Å–µ—Ç—Ç–µ—Ä–∞–º–∏.

–¢–∞–∫–∂–µ —Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ **@Autowired** - –º–æ–∂–Ω–æ –∏–Ω–∂–µ–∫—Ç–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏.

**@Value** - –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–Ω–∂–µ–∫—Ç–∞—Ç—å —á–µ—Ä–µ–∑ **expression language**.

## 19. Classpath Scanning
–ü—Ä–∏–Ω—è—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ.

```xml
<context:component-scan base-package="packacge"/>
```

ComponentScanBeanDefinitionParser –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–∞—Ç—å –∫–ª–∞—Å—Å—ã, –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –∫–æ—Ç–æ—Ä—ã—Ö –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å bean'—ã (bean definition'—ã, –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ). –§–∏–ª—å—Ç—Ä –ø–æ–∏—Å–∫–∞ - –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è **@Component** (**@Controller**, **@Repository**, **@Service**).

**@Component("")** - –¥–∞—ë—Ç id. –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤ —Å –º–∞–ª–µ–Ω—å–∫–æ–π –±—É–∫–≤—ã.

–ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–≤, —Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫–∞–Ω –≤—ã–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å **@Autowired**. –ï—Å–ª–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –æ–¥–∏–Ω - –≤—ã–∑—ã–≤–∞–µ—Ç –µ–≥–æ.

## 20. Bean Definition Readers
- Bean Definition Readers
  - BeanDefinitionReader == XML-based configuration
    - XmlBeanDefinitionReader
    - GroovyBeanDefinitionReader
    - PropertiesBeanDefinitionReader
  - ClassPathBeanDefinitionReader & AnnotatedBeanDefinitionReader == Annotation-based configuration
    - TypeFilter
  - ConfigurationClassBeanDefinitionReader == Java-based configuration
    - @Configuration
      - @Bean

BeanDefinitionParser - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –†–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ I/O.

## 21. Type Filters
```xml
<!--    <context:annotation-config></context:annotation-config>-->
<context:component-scan base-package="com.dmdev.spring"
                        annotation-config="true"
                        resource-pattern="**/*.class"
                        scoped-proxy="no"
                        use-default-filters="false">
```

**annotation-config="true"** –≤–º–µ—Å—Ç–æ \<context:annotation-config></context:annotation-config>.

**name-generator** - —Å–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–º–µ–Ω.

**resource-pattern="**/*.class"** - –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞.

**scoped-proxy="no"** - —Ç–∏–ø –ø—Ä–æ–∫—Å–∏:
- no
- interfaces
- targetClass - –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (–≤ Spring –∏—Å–ø–æ–ª–∑—É–µ—Ç—Å—è CGLIB)

**scoped-proxy="no"**

**use-default-filters="true"** - —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–∏–Ω–æ–≤ –≤ –ø–∞–∫–µ—Ç–µ.
- annotation
- assignable
- regex
- aspectj
- custom

## 22. Scope
**AnnotationScopeMetaDataResolver** –∏—â–µ—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é **@Scope**.

–ï—Å—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Å–æ–æ—Ç–≤. —Å–∫–æ—É–ø–æ–≤.

## 23. JSR-250 & JSR-330
JSR-250:
Managed Bean == Value

JSR-330:
DI-—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è.
Inject == Autowired
Named == Component, Qualifier
Qualifer == Qualifier
Singleton == Scope
Scope

## 24. Java-based configuration
–°–æ–∑–¥–∞—é—Ç—Å—è –∫–ª–∞—Å—Å—ã –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π. –ö–ª–∞—Å—Å –ø–æ–º–µ—á–∞–µ—Ç—Å—è **@Configuration**.

**@PropertySource("classpath:application.properties")**.

**@ComponentScan()** - —Ç–µ –∂–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —á—Ç–æ –∏ –≤ XML.

## 25. Import & ImportResource
**@ImportResource** - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å XML.
**@Import** - –¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø. –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã.

## 26. Bean I
–í **@Configuration** –∫–ª–∞—Å—Å–∞—Ö –≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –±–∏–Ω—ã —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:
```java
@Bean("pool2")
@Scope(BeanDefinition.SCOPE_SINGLETON)
public ConnectionPool pool2(@Value("${db.username}") String username) {
    return new ConnectionPool(username, 20);
}

@Bean
public UserRepository userRepository2(ConnectionPool pool2) {
    return new UserRepository(pool2);
}
```

**–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç–æ–¥–∞ == id –±–∏–Ω–∞!**
**–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ == id –±–∏–Ω–∞!**

## 27. Bean II
```java
@Bean
public UserRepository userRepository3() {
    var connectionPool1 = pool3();
    var connectionPool2 = pool3();
    var connectionPool3 = pool3();
    return new UserRepository(pool3());
}
```

–°–æ–∑–¥–∞—Å—Ç—Å—è 1 –ø—É–ª (—Ç. –∫. —Å–∏–Ω–≥–ª—Ç–æ–Ω). **ApplicationConfiguration** –æ–±—ë—Ä–Ω—É—Ç –≤ –ø—Ä–æ–∫—Å–∏ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–µ–π). –í –Ω—ë–º –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –º–µ—Ç–æ–¥ **intercept()**.

## 28. Profiles
–ù–∞—Ö–æ–¥—è—Ç—Å—è –≤ Environment. –ü–æ–∑–≤–æ–ª—è—é—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç\–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ –±–∏–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∞–π–ª–∞.

–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è @Profile —Å—Ç–∞–≤–∏—Ç—Å—è –Ω–∞–¥ –∫–ª–∞—Å—Å–∞–º–∏-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏ –∏ –º–µ—Ç–æ–¥–∞–º–∏. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±—É–ª–µ–≤—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –ò\–ò–õ–ò.

–ü—Ä–∏–º–µ—Ä –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤ application.properties:
```properties
spring.profiles.active=web
```

~~–ü—Ä–æ—Ñ–∏–ª–∏ –º–æ–∂–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç. –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–¥–æ –≤—ã–∑–≤–∞—Ç—å refresh() (–¢–∞–º —á–µ-—Ç–æ —Å–ª–æ–∂–Ω–æ, –ø—Ä–∞–≤–¥–∞).~~

## 29. Event Listeners I
Listener - subscribe/unsubscribe (–¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–∏—Å–µ–Ω–µ—Ä–∞ –≤ —Å–ø–∏—Å–æ–∫).

Event - –Ω–∞–±–æ—Ä –ø–æ–ª–µ–π.

–ü—Ä–∏–º–µ—Ä:
```java
public enum AccessType {
    CREATE, UPDATE, READ, DELETE
}

public class EntityEvent extends EventObject /*extends ApplicationEvent - –ª—É—á—à–µ*/ {

    private final AccessType accessType;

    public EntityEvent(Object entity, AccessType accessType) {
        super(entity);
        this.accessType = accessType;
    }

    public AccessType getAccessType() {
        return accessType;
    }
}

@Component
public class EntityListener {

    @EventListener
    @Order(10)
    public void acceptEntity(EntityEvent entityEvent) {
        System.out.println("Entity: " + entityEvent);
    }
}

/* class CompanyService: */
private final ApplicationEventPublisher eventPublisher;

public Optional<CompanyReadDto> findById(Integer id) {
    return companyRepository.findById(id)
        .map(entity -> {
            eventPublisher.publishEvent(new EntityEvent(entity, AccessType.READ));
            return new CompanyReadDto(entity.id());
        });
}
```

## 30. Event Listeners II
–ö–æ–ª–ª–µ–∫—Ü–∏—é –ª–∏—Å—Ç–µ–Ω–µ—Ä–æ–≤ –º–æ–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å –ø–æ–º–æ—â—å—é **@Order**.

**@EventListener** –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å condition –≤–º–µ—Å—Ç–µ —Å SpEL: –Ω–∞–ø—Ä–∏–º–µ—Ä, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å args –ª–∏—Å—Ç–µ–Ω–µ—Ä–∞.

–ü—Ä–∏–º–µ—Ä:
```java
@Component
public class EntityListener {

    @EventListener(condition="#root.args[0].accessType.name() == 'READ'")
    @Order(10)
    public void acceptEntity(EntityEvent entityEvent) {
        System.out.println("Entity: " + entityEvent);
    }
}
```

## 31. Spring Boot –í–≤–µ–¥–µ–Ω–∏–µ
SpringBoot –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç AutoConfiguration.

–° –ø–æ–º–æ—â—å—é Conditions –∏–º–µ–µ—Ç—Å—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∫–ª—é—á–∞—Ç—å\–≤—ã–∫–ª—é—á–∞—Ç—å –º–æ–¥—É–ª–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏. –û–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∏—Å—Ö–æ–¥—è –∏–∑ classpath/properties/bean.

Starters –¥–æ–±–∞–≤–ª—è—é—Ç –Ω—É–∂–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª.

## 32. Conditional
**@Conditional**
–¢–∞—Ä–≥–µ—Ç - —Ç–∏–ø –∏ –º–µ—Ç–æ–¥ (–º–µ—Ç–æ–¥, –ø–æ–º–µ—á–µ–Ω–Ω—ã–π **@Bean**!).

–ü—Ä–∏–º–µ—Ä:
```java
@Conditional(JpaCondition.class)
@Configuration
public class JpaConfiguration {

    @PostConstruct
    void init() {
        System.out.println("Jpa configuration is enabled");
    }
}

public class JpaCondition implements Condition {

    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        try {
            context.getClassLoader().loadClass("org.postgresql.Driver");
            return true;
        } catch (ClassNotFoundException e) {
            return false;
        }
    }
```

**@Profile** –ø–æ–º–µ—á–µ–Ω **@Conditional**!

## 33. Spring Boot –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è spring-boot-starter.

–í–æ—Ç —Ç–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ Spring Boot:
```java
@SpringBootApplication
public class ApplicationRunner {

    public static void main(String[] args) {
        SpringApplication.run(ApplicationRunner.class, args);
    }
}
```

–¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å [Spring Initializr](https://start.spring.io/).

–í Maven –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è spring-boot-starter-parent.

## 34. SpringBootApplication
–î–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å –≤ —Ä—É—Ç–æ–≤–æ–º –ø—Ä–æ–µ–∫—Ç–µ.

**run()** - —Å–æ–∑–¥–∞—ë—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç.

–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è **@SpringBootApplication** –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ–¥–Ω–∞. **@SpringBootApplication** –ø–æ–º–µ—á–µ–Ω **@SprinBootConfiguration** –∏ **@ComponentScan**.

## 35 Lombok
**@RequiredArgsConstructor - –¥–ª—è –ø–æ–ª–µ–π final.**
**@AllArgsConstuctor** - –¥–ª—è –≤—Å–µ—Ö.

**@Value** (Spring) –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –Ω–∞ –ø–æ–ª–µ, –∏ –≤ lombok.config –¥–æ–±–∞–≤–∏—Ç—å –Ω—É–∂–Ω—ã–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏:
```
config.stopBubbling = true

lombok.copyableannotations += org.springframework.beans.factory.annotation.Value
lombok.copyableannotations += org.springframework.beans.factory.annotation.Qualifier
```

stopBubbling - —Ä—É—Ç–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥.

## 36. Properties
**spring.properties** - low-level –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Spring.

–ü—Ä–æ–ø–µ—Ä—Ç–∏ –∏–µ—Ä–∞—Ä—Ö–∏—á–Ω—ã, –æ–¥–Ω–∏ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç –¥—Ä—É–≥–∏–µ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É.

–ü—Ä–æ—Ñ–∏–ª–∏ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ **application.properties**. –ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è **application-{profile}.properties**. –í **application.properties** –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è:
```properties
spring.profiles.active={profile}
```

–í –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–≤–∞ –¥–µ—Ñ–∏—Å–∞ (*TODO: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ª–∏*).

VM options –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å -D.

Property Placeholders - –ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è, –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è. –î–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ç–∞–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –¥–≤–æ–µ—Ç–æ—á–∏—è. –ü—Ä–∏–º–µ—Ä:
```properties
db.username=${username.value:postgres}
```

–í –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å
```
--spring.config.location={location}
```

–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥ —ç—Ç–∏–º "optional:".

## 37. yaml
–ü—Ä–∏–º–µ—Ä application.yaml:
```yaml
db:
  username: ${username.value:postgres}
  password: pass
  driver: PostgresDriver
  url: postgres:5432
  hosts: localhost,127.0.0.1
  pool:
    size: 12
    timeout: 10
  pools:
    - size: 1
      timeout: 1
    - size: 2
      timeout: 2
    - size: 3
      timeout: 3
spring.profiles.active: qa
```

## 38. ConfigurationProperties
–ú–æ–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å yaml –≤ Bean! –î–ª—è —ç—Ç–æ–≥–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –Ω–µ–≥–æ –≤—Å–µ –ø–æ–ª—è.

–ü—Ä–∏–º–µ—Ä:
```java
@ConfigurationProperties(prefix = "db")
public record DatabaseProperties(String username,
                                 String password,
                                 String driver,
                                 String url,
                                 String hosts,
                                 PoolProperties pool,
                                 List<PoolProperties> pools,
                                 Map<String, Object> properties) {

    public static record PoolProperties(Integer size,
                                        Integer timeout) {
    }
}
```
–î–æ–ª–∂–µ–Ω –±—ã—Ç—å POJO: –≥–µ—Ç—Ç–µ—Ä—ã, —Å–µ—Ç—Ç–µ—Ä—ã –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å Bean:
```java
@Bean
@ConfigurationProperties(prefix = "db")
public DatabaseProperties databaseProperties() {
    return new DatabaseProperties();
}
```
–ê –º–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å **@ConfigurationProperties(prefix = "db")** —É –∫–ª–∞—Å—Å–∞, –¥–æ–±–∞–≤–∏—Ç—å **@Component**, —É **ApplicationRunner** –¥–æ–±–∞–≤–∏—Ç—å **@ConfigurationPropertiesScan**.

## 39. logging-starter
**@Slf4j** –∏–∑ Lombok –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ª–æ–≥–≥–µ—Ä.

–í yaml –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
```yaml
logging:
  level:
    root: WARN
    com.dmdev.spring.database.pool: INFO
```

## 40. Logback Configuration
–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª–æ–≤—ã–π –ª–æ–≥–≥–µ—Ä:
```yaml
logging:
  level:
    root: WARN
    com.dmdev.spring.database.pool: INFO
  file:
    name: dmdev.log
    path: /
```

–û—Å—Ç–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ **logback-spring.xml**:
```xml
<configuration>

    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <!-- encoders are assigned the type
             ch.qos.logback.classic.encoder.PatternLayoutEncoder by default -->
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <root level="INFO">
        <appender-ref ref="STDOUT" />
    </root>
</configuration>
```

## 41. test-starter
junit, mockito –µ—Å—Ç—å —Ç—Ä–∞–Ω–∑–∏—Ç–∏–≤–Ω–æ –≤ test-starter.

**@ExtendWith(MockitoExtension.class)**

## 42. Integration Testing I
–¶–µ–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –≤ Spring:
- DI (Spring Context Beans)
- Context Caching
- Transaction Management

–ò—Å–ø–æ–ª—å–∑—É–µ–º SpringExtension: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç-–∫–ª–∞—Å—Å–∞ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω **TestContextManager**: –≤ –Ω—ë–º –µ—Å—Ç—å **TestContext** –∏ **TextExecutionListener**.

## 43. Integration Testing II
–ü–æ—Å—Ç—Ñ–∏–∫—Å **IT** –¥–ª—è –∫–ª–∞—Å—Å–æ–≤ –∑–∞—Ä–µ–∑—Ä–≤–∏—Ä–æ–≤–∞–Ω –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤.

**@ExtendWith(SpringExtension.class)**
**@ContextConfiguration(classes = ApplicationRunner.class)** - –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

**@TestPropertySource** - –¥–ª—è **application.properties**. –î–ª—è YAML –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –†–µ—à–µ–Ω–∏–µ: –≤ **@ContextConfiguration** –µ—Å—Ç—å **initializers = ConfigApplicationContextInitializer**.

–í–º–µ—Å—Ç–æ
```java
@ExtendWith(SpringExtension.class)
@ContextConfiguration(classes = ApplicationRunner.class, initializers = ConfigDataApplicationContextInitializer.class)
```

–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
```java
@SpringBootTest
```

**@SpringBootTest** –Ω–∞–π–¥–µ—Ç spring Boot –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

–ü—Ä–∏–º–µ—Ä **—é–Ω–∏—Ç-—Ç–µ—Å—Ç–∞**:
```java
@ExtendWith(MockitoExtension.class)
class CompanyServiceTest {

    private static final Integer COMPANY_ID = 1;

    @Mock
    private CrudRepository<Integer, Company> companyRepository;
    @Mock
    private UserService userService;
    @Mock
    private ApplicationEventPublisher eventPublisher;
    @InjectMocks
    private CompanyService companyService;

    @Test
    void findById() {
        doReturn(Optional.of(new Company(COMPANY_ID)))
            .when(companyRepository).findById(COMPANY_ID);

        var actualResult = companyService.findById(COMPANY_ID);

        assertTrue(actualResult.isPresent());

        var expectedResult = new CompanyReadDto(COMPANY_ID);
        actualResult.ifPresent(actual -> assertEquals(expectedResult, actual));

        verify(eventPublisher).publishEvent(any(EntityEvent.class));
        verifyNoMoreInteractions(eventPublisher, userService);
    }
}
```

–ü—Ä–∏–º–µ—Ä **–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞**:
```java
@SpringBootTest
public class CompanyServiceIT {

    private static final Integer COMPANY_ID = 1;

    @Autowired
    private CompanyService companyService;

    @Test
    void findById() {
        var actualResult = companyService.findById(COMPANY_ID);

        assertTrue(actualResult.isPresent());

        var expectedResult = new CompanyReadDto(COMPANY_ID);
        actualResult.ifPresent(actual -> assertEquals(expectedResult, actual));
    }
```

TestContext Framework –∏–∂–µ–∫—Ç–∏—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ —Ç–µ—Å—Ç—ã.

## 44. Integration Testing III
–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å properties –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤.

–ß—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å –≤—Å–µ –ø—Ä–æ–ø–µ—Ä—Ç–∏, —Å–ª–µ–¥—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å application-test.yml –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å: **@ActiveProfiles("test")**.

–í–º–µ—Å—Ç–æ **@Autowired** –Ω–∞ –ø–æ–ª—è—Ö, –º–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å **@RequiredArgsConstructor** –∏  **@TestConstructor(autowireMode = TestConstructor.AutowireMode.ALL)**.

–ê –º–æ–∂–Ω–æ –≤ **spring.properties** –ø–æ—Å—Ç–∞–≤–∏—Ç—å **spring.test.constructor.autowire.mode=all**.

## 45. Context Caching
–ö–æ–Ω—Ç–µ–∫—Å—Ç—ã –Ω–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –±–µ–∑ **@ContextConfiguration**. 

–ú–æ–∫–∏ –º–æ–≥—É—Ç –≤—Å—ë —Å–ª–æ–º–∞—Ç—å.

**@MockBean** –∏ **@SpyBean** - –ø–æ–¥–º–µ–Ω—è—Ç—å –±–∏–Ω—ã => –ª–æ–º–∞—é—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç.

–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å **@TestConfiguration** –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **@MockBean** –∏ **@SpyBean** —Ç–∞–º:
```java
@TestConfiguration
public class TestApplicationRunner {

    @SpyBean(name = "pool1")
    private ConnectionPool pool1;
}
```

–∏ –µ–≥–æ —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ **@SpringBootTest(classes)**.

**@DirtyContext** - –ø–æ–º–µ—á–∞–µ—Ç –∫–æ–Ω–µ—Ç–µ–∫—Å—Ç –∫–∞–∫ dirty. –¢–æ–≥–¥–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.

*–õ—É—á—à–µ –≤—Å–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Å–æ–±–∏—Ä–∞—Ç—å –≤–º–µ—Å—Ç–µ:*
```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@ActiveProfiles("test")
@SpringBootTest(classes = TestApplicationRunner.class)
public @interface IT {
}
```

## 46. data-jpa-starter –í–≤–µ–¥–µ–Ω–∏–µ
–ü–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ—â–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ (—Å –ø–æ–º–æ—â—å—é TransactionManager), –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≥–æ—Ç–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.

## 47. data-jpa-starter –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.
–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å data-jpa-starter.

–ü—Ä–æ–ø–µ—Ä—Ç–∏:
```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5433/postgres
    username: postgres
    password: pass
    driver-class-name: org.postgresql.Driver
  jpa:
    properties.hibernate:
      show_sql: true
      format_sql: true
```

## 48. Hibernate Entities.
–°—É—â–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å mutable!

*TODO: ElementCollection*

## 49. Transactional. TestContext
**TransactionManager** –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç—Å—è –≤ **JpaBaseConfiguration**.

**TransactionManager** –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ (**@Transactional**) –∏ –º–∞–Ω—É–∞–ª—å–Ω–æ (**TransactionTemplate**).

**@Transactional**:
- TestContext - —Å –ø–æ–º–æ—â—å—é –ª–∏—Å—Ç–µ–Ω–µ—Ä–æ–≤;
- AOP - –ø—Ä–æ–∫—Å–∏ CGLIB.

*@Transactional –∏–∑ Spring!*

–í **TestContext** –≤ –∫–æ–Ω—Ü–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **rollback**!
–ï—Å—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ **@Rollback** –∏ **@Commit**.

–ê —Ç–∞–∫–∂–µ **@BeforeTransaction** –∏ **@AfterTransaction**.

## 50. TransactionAutoConfiguration
**TransactionProperties** –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ spring.transasction.

spring.aop - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–∫—Å–∏ (Dynamic/CGLIB). –ü–æ —É–º–∞–ª–æ—á–∞–Ω–∏—é - CGLIB.

**@Transactional** –Ω–∞–¥ –∫–ª–∞—Å—Å–æ–º == –Ω–∞–¥ –≤—Å–µ–º–∏ –º–µ—Ç–æ–¥–∞–º–∏. –≠—Ç–∞ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞–¥ public –º–µ—Ç–æ–¥–∞–º–∏!

## 51. Transactional Settings
1. **propagation()** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º –º–µ–∂–¥—É CGLIB-–ø—Ä–æ–∫—Å–∏ –≤ —Å–ª—É—á–∞–µ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

   - **REQUIRED** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ —Ç–µ–∫—É—â–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –ï—Å–ª–∏ –µ–µ –Ω–µ—Ç - –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç;
   - **SUPPORTS** - -//-, –Ω–æ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é;
   - **MANDATORY** - —Ç–æ–∂–µ —Å–∞–º–æ–µ, –Ω–æ –±—Ä–æ—Å–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ —Å–ª—É—á–∞–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏;
   - **REQUIRES_NEW** - –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (**–Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ!**);
   - **NOT_SUPPORTED** - –±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏; –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –µ–µ, –µ—Å–ª–∏ –µ—Å—Ç—å;
   - **NEVER** - –±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏; –±—Ä–æ—Å–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å;
   - **NESTED** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç savepoint'—ã, —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å JDBC Template.

2. **isolation()** - –≤—Å—ë —Ç–∞–∫ –∂–µ. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

3. **readOnly()** - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö . –î–ª—è Hibernate –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç flush'–∞ —Å–µ—Å—Å–∏–∏.

4. **rollbackFor()** - –ø—Ä–∏ –∫–∞–∫–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏—è—Ö –Ω–∞–¥–æ –¥–µ–ª–∞—Ç—å rollback. –ü–æ –¥–µ—Ñ–æ–ª—Ç—É - **RuntimeException | Error.**

## 52. Manual Transactions
**TransactionTemplate** (—è–≤–ª—è–µ—Ç—Å—è –±–∏–Ω–æ–º) –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏.

–ü—Ä–∏–º–µ—Ä:
```java
@IT
@RequiredArgsConstructor
class CompanyRepositoryTest {

    private final EntityManager entityManager;
    private final TransactionTemplate transactionTemplate;

    @Test
    void findById() {
        transactionTemplate.executeWithoutResult(tx -> {
            var company = entityManager.find(Company.class, 1);
            assertNotNull(company);
            assertThat(company.getLocales()).hasSize(2);
        });
    }
}
```

## 53. Repository
–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å **Repository** - –º–∞—Ä–∫–µ—Ä–Ω—ã–π. –ê–≤—Ç–æ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è **JpaRepositoryAutoConfiguration** —Å–æ–∑–¥–∞—ë—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é.

–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è **@Repository** –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞.

## 54. RepositoryQuery
–î–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –ø—Ä–æ—â–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Dynamic proxy.

**RepositoryQuery** - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å  –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ data-jpa. –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
- **NamedQuery** - –∏–º–µ–Ω–Ω–æ–π SQL-–∑–∞–ø—Ä–æ—Å (*–ø–æ—Ö–æ–∂–µ, —á—Ç–æ –∏ JPQL*). –ù–∞–∑—ã–≤–∞—Ç—å –Ω–∞–¥–æ –∫–∞–∫ –º–µ—Ç–æ–¥—ã;
- **NativeJpaQuery** - –Ω–∞—Ç–∏–≤–Ω—ã–π SQL-–∑–∞–ø—Ä–æ—Å;
- **PartTreeJpaQuery** - –∑–∞–ø—Ä–æ—Å—ã –ø–æ –∏–º–µ–Ω–æ–≤–∞–Ω–∏—é —á–µ—Ä–µ–∑ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤ CriteriaAPI.
- **SimpleJpaQuery** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HQL;
- **StoredProceureJpaQuery** - —Ö—Ä–∞–Ω–∏–º—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã.

–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã-–Ω–∞—Å–ª–µ–¥–Ω–∏–∫–∏:
- **CrudRepository** extends Repository;
- **PagingAndSortingRepository** extends CrudRepository;
- **JpaRepository** extends PagingAndSortingRepository - —Ä–∞–±–æ—Ç–∞ —Å –±–∞—Ç—á–∞–º–∏, flush'–µ–º —Å–µ—Å—Å–∏–∏ –∏ —Ç. –¥.

## 55. PartTreeJpaQuery
–ù–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –º–µ—Ç–æ–¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å —Å –ø–æ–º–æ—â—å—é Criteria API. –†–∞–±–æ—Ç–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π.

–ë–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –≤—Å—Ç–∞–≤–∫–∏.

Containing - –∞–Ω–∞–ª–æ–≥ like.

## 56. Named Query
–ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ JPA.

–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è **@NamedQuery**. –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –∫–∞–∫ "Company.findByName".

## 57. Query
**StoredProcedureJpaQuery** - –∞–Ω—Ç–æ—Ü–∏—è **@Procedure**.

**@Query** - –Ω–∞–¥  –º–µ—Ç–æ–¥–∞–º–∏.
- nativeQuery - SimpleJpaQuery (HQL) / NativeJpaQuery (SQL).
- value - –∑–∞–ø—Ä–æ—Å.

**join fetch –≤ HQL - –æ–¥–∏–Ω –∏–∑ –ª—É—á—à–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤!**

–í Spring Data, –≤ –æ—Ç–ª–∏—á–∏–∏ –æ—Ç HQL –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç—ã:
```java
@Query("select u from User u "
+ "where u.firstname like %:firstname")
```

–î–ª—è native queries —Ç–∞–∫–∂–µ –Ω—É–∂–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –≤ resultSet –ø–æ–ª—è, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ —Å—É—â–Ω–æ—Å—Ç–∏ Repository (–≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ - —ç—Ç–æ User) –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ü–∏–∏.

HQL - –∫—Ä—É—Ç–æ, —Ç.–∫. fetch join.

## 58. Modifying
–ß—Ç–æ–±—ã **@Query** —Ä–∞–±–æ—Ç–∞–ª —Å DML –Ω–∞–¥–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é **@Modifying**. –ù–æ —Ç–∞–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –º–∏–º–æ **PersistentContext**.

–ù—É–∂–Ω–æ —á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å PersistentContext. –£ **@Modifying** –µ—Å—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞ flushAuto –∏ clearAuto:
- **flushAutomatically** - —Å–ª–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞.
- **clearAutomatically** - —á–∏—Å—Ç–∏—Ç –≤–µ—Å—å –∫–æ–Ω–µ–∫—Å—Ç –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞.

–ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ —Å LazyInitEx –ø—Ä–∏ clearAutomatically! 

## 59. Special Parameters
–í **PartTreeJpaQuery** –µ—Å—Ç—å –¥–æ–ø. –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: All, Distinct, First, Top, DistinctFirst, DistinctTop.

–î–ª—è First/Top –Ω—É–∂–Ω–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ => Asc/Desc.

–ü–∞—Ä–∞–º–µ—Ç—Ä, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–æ–≤–∞—Ç—å - **sort**.

–ü–∞—Ä–∞–º–µ—Ç—Ä, –≤–∫–ª—é—á–∞—é—â–∏–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É - **Pageable**. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç **limit** –∏ **offset**.

```java
    Optional<User> findTopByOrderByIdDesc();

    List<User> findTop3ByBirthDateBefore(LocalDate birthDate, Sort sort);

    List<User> findAllBy(Pageable pageable);
```

```java
@Test
    void checkPageable() {
        var pageable = PageRequest.of(1, 2, Sort.by("id"));
        var result = userRepository.findAllBy(pageable);
        assertThat(result).hasSize(2);
    }

    @Test
    void checkSort() {
        var sortBy = Sort.sort(User.class);
        var sort = sortBy.by(User::getFirstname)
            .and(sortBy.by(User::getLastname));

        var sortById = Sort.by("firstname").and(Sort.by("lastname"));
        var allUsers = userRepository.findTop3ByBirthDateBefore(LocalDate.now(), sort);
        assertThat(allUsers).hasSize(3);
    }

    @Test
    void checkFirstTop() {
        var topUser = userRepository.findTopByOrderByIdDesc();
        assertTrue(topUser.isPresent());
        topUser.ifPresent(user -> assertEquals(5L, user.getId()));
    }
```

## 60. Page Slice
–ï—Å—Ç—å –µ—â–µ **Streamable**, **Slice** –∏ **Page**.

–í–≤–æ–¥—è—Ç StreeamAPI-like —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª.

–£–¥–æ–±–Ω–æ - **slice.hasNext()** –∏ **slice.nextPageable()**.

–í **Page** (–Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç Slice)–µ—Å—Ç—å **count** –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–∞–Ω–∏—Ü.

–í **@Query** –º–æ–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å count.

## 61. EntityGraph
**@EntityGraph**:
- value - –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∞.
- attributePaths - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ—Ö —Å–≤–æ–π—Å—Ç–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø–æ–¥—Ç—è–Ω—É—Ç—å.
- type:
  - fetch - –≤—Å–µ —Å–≤—è–∑–∏ lazy, –∞ —Ç–µ, —á—Ç–æ –≤ –≥—Ä–∞—Ñ–µ, - eager.
  - load - –≤—Å–µ –º–∞–ø–ø–∏–Ω–≥–∏ –æ—Å—Ç–∞—é—Ç—Å—è, –∫–∞–∫ –µ—Å—Ç—å.

–í attributePaths —Å–∞–±–≥—Ä–∞—Ñ—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–æ—â–µ:
```java
@EntityGraph(attributePaths = {"company", "company.locales"})
```

Pageable –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∏ —Ä–∞–∑–¥–≤–∞–∏–≤–∞—é—Ç—Å—è.

## 62. Lock. QueryHints
**@Lock**:
- **LockModeType:**
  - **OPTIMISTIC** - –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ù—É–∂–Ω–æ –¥–æ–ø. –ø–æ–ª–µ **version**. Version –º–µ–Ω—è—é—Ç—Å—è, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—É—â–Ω–æ—Å—Ç—å –±—ã–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∞.
  - **OPTIMISTIC_FORCE_INCREMENT** - —Ç–æ–∂–µ —Å–∞–º–æ–µ, –Ω–æ version –º–µ–Ω—è–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞.
  - ~~READ~~
  - **PESSIMISTIC_FORCE_INCREMENT** - –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î –ø–æ —Å—Ç—Ä–æ–∫–∞–º + –ø–æ–ª–µ version.
  - **PESSIISTIC_READ** - select for share (PostgereSQL) –ø–æ —Å—Ç—Ä–æ–∫–∞–º .
  - **PESSIISTIC_WRITE** - select for update (PostgereSQL) –ø–æ —Å—Ç—Ä–æ–∫–∞–º .
  - ~~WRITE~~

@QueryHint - —Ç–∞–π–º–∞—É—Ç, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, fetch size...

## 63. Projection (Hibernate Projection)
–≠—Ç–æ –º–∞–ø–ø–µ—Ä DTO. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Å–∞–º –ø—Ä–∏ —Å–æ–æ—Ç–≤–µ—Å—Ç–≤–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª–µ–π –≤ —Å—É—â–Ω–æ—Å—Ç—è—Ö.

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∂–µ–Ω–µ—Ä–∏–∫–æ–º:
```java
<T> List<T> findAllByCompanyId(Integer companyId, Class<T> clazz);
```

–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã-–î–¢–û —Ä–∞–±–æ—Ç–∞—é—Ç —Å **NativeQuery**. –¢–∞–º –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –º–µ—Ç–æ–¥—ã.

–ï—â–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Expression Laguage!

```java
@Value("#{target.firstname + ' ' + target.lasname}")
String getFullName();
```

## 64. Custom Repository Implementation
**EntityManager –µ—Å—Ç—å –≤ Spring-–∫–æ–Ω—Ç–µ–∫—Å—Ç–µ!**

–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, –Ω–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ Impl –∏ —Å–¥–µ–ª–∞—Ç—å –≤–æ—Ç —Ç–∞–∫ (–≤—Ç–æ—Ä–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å) (–≤–∞—É):
```java
public interface UserRepository extends JpaRepository<User, Long>, FilterUserRepository
```

## 65. JPA Auditing
–í Spring –µ—Å—Ç—å —Å–≤–æ–π **AuditingEntityListener**:
```java
@EntityListener(AuditingEntityListener.class)
```

–° –Ω–∏–º –∏–¥—É—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏:
- **@CreatedDate**
- **@LastModifiedDate**
- **@CreatedBy**
- ...

–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
```java
@EnableJpaAuditing
@Configuration
public class AuditConfiguration
```

–î–ª—è –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ–ª–µ–π:
```java
@EnableJpaAuditing
@Configuration
public class AuditConfiguration {
    @Bean
    public AuditorAware<String> auditorAware() {
        // –ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ —é–∑–µ—Ä –¥–æ—Å—Ç–∞–µ—Ç—Å—è –∏–∑ —Å–µ–∫—å—é—Ä–∏—Ç–∏-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        return () -> Optional.of("");
    }
}
```

## 66. Hibernate Envers
–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å spring-data-envers.

**@RevisionEntity** –∏–∑ Hibernate - –æ–¥–Ω–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

*TODO: –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ –≤ –∫—É—Ä—Å–µ Hibernate –∏ –¥–æ–ø–∏—Å–∞—Ç—å*

## 67. QueryDSL
–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ querydsl-jpa –∏ querydsl-api, –∞ —Ç–∞–∫–∂–µ –ø–ª–∞–≥–∏–Ω querydsl.

–ü—Ä–∏–º–µ—Ä:
```java
@NoArgsConstructor(access = AccessLevel.PRIVATE)
public class QPredicates {

    private final List<Predicate> predicates = new ArrayList<>();

    public static QPredicates builder() {
        return new QPredicates();
    }

    public <T> QPredicates add(T object, Function<T, Predicate> function) {
        if (object != null) {
            predicates.add(function.apply(object));
        }
        return this;
    }

    public Predicate build() {
        return ExpressionUtils.allOf(predicates);
    }

    public Predicate buildOr() {
        return ExpressionUtils.anyOf(predicates);
    }
}
```

```java
@RequiredArgsConstructor
public class FilterUserRepositoryImpl implements FilterUserRepository {

    private final EntityManager entityManager;

    @Override
    public List<User> findAllByFilter(UserFilter filter) {
        var predicate = QPredicates.builder()
            .add(filter.firstname(), user.firstname::containsIgnoreCase)
            .add(filter.lastname(), user.lastname::containsIgnoreCase)
            .add(filter.birthDate(), user.birthDate::before)
            .build();

        return new JPAQuery<User>(entityManager)
            .select(user)
            .from(user)
            .where(predicate)
            .fetch();
    }
```

```java
public interface UserRepository extends
    JpaRepository<User, Long>,
    FilterUserRepository,
    RevisionRepository<User, Long, Integer>,
    QuerydslPredicateExecutor<User> {
        ...
    }
```

**fetch()** - –¥–ª—è –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π.

## 68. JDBC Starter
–û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - **JdbcTemplateAutoConfiguration**.

–û—Å–Ω–æ–≤–Ω–π –±–∏–Ω - **JdbcTemplate**.

**NamedParameterJdbcTemplateConfiguration** –ø—Ä–∏–≤–Ω–æ—Å–∏—Ç **NamedParameterJdbcTemplate**, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–≤–º–µ—Å—Ç–æ –≤–æ–ø—Ä–æ—Å–∏–∫–æ–≤).

–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å **JdbcOperation** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î:
- **execute()** - –ª—é–±—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –¥–∞–∂–µ DDL.
- **query()** - –¥–ª—è SELECT.
  - **queryForList()** - –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –æ–¥–Ω–æ–π –∫–æ–ª–æ–Ω–∫–∏ –∏–∑ –ë–î.
  - **queryForMap()**
  - **queryForRowSet()**
- ...

–ü—Ä–∏–º–µ—Ä:
```java
@RequiredArgsConstructor
public class FilterUserRepositoryImpl implements FilterUserRepository {
    private static final String FIND_BY_COMPANY_AND_ROLE = """
        SELECT 
            firstname,
            lastname,
            birth_date
        FROM users
        WHERE company_id = ?
            AND role = ?
        """;

    private final JdbcTemplate jdbcTemplate;

    @Override
    public List<PersonalInfo> findAllByCompanyIdAndRole(Integer companyId, Role role) {
        return jdbcTemplate.query(FIND_BY_COMPANY_AND_ROLE,
            (rs, rowNum) -> new PersonalInfo(
                rs.getString("firstname"),
                rs.getString("lastname"),
                rs.getDate("birth_date").toLocalDate()
            ), companyId, role.name());
    }
}
```

**rowMapper** (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å) - –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è **resultSet** –≤ DTO.

## 69. Batch & Fetch sizes
–ü—Ä–∏–º–µ—Ä:
```java
@Override
public void updateCompanyAndRole(List<User> users) {
    var args = users.stream()
        .map(user -> new Object[]{user.getCompany().getId(), user.getRole().name(), user.getId()})
        .toList();

    jdbcTemplate.batchUpdate(UPDATE_COMPANY_AND_ROLE, args);
}
```

```java
private static final String UPDATE_COMPANY_AND_ROLE_NAMED = """
    UPDATE users
    SET company_id = :companyId,
        role = :role
    WHERE id = :id
    """;

NamedParameterJdbcTemplate namedJdbcTemplate;

 @Override
    public void updateCompanyAndRoleNamed(List<User> users) {
        var args = users.stream()
            .map(user -> Map.of(
                "companyId", user.getCompany().getId(),
                "role", user.getRole().name(),
                "id", user.getId()
            ))
            .map(MapSqlParameterSource::new)
            .toArray(MapSqlParameterSource[]::new);

        namedJdbcTemplate.batchUpdate(UPDATE_COMPANY_AND_ROLE_NAMED, args);
    }
```

**–£ Hibernate –µ—Å—Ç—å —Å–≤–æ–π batchSize!**

–î–ª—è SELECT-–∑–∞–ø—Ä–æ—Å–æ–≤ - **fetchSize**. –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∑–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.

## 70. In Memory DBs. H2
–í Spring –µ—Å—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è **@Sql**, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞. –ú–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –Ω–∞–¥ –∫–ª–∞—Å—Å–æ–º, —Ç–∞–∫ –∏ –Ω–∞–¥ –º–µ—Ç–æ–¥–æ–º.

## 71. Testcontainers
**@DynamicPropertySource** –ø–æ–∑–≤–æ–ª—è–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å JDBC URL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

## 72. Liquidbase I
Migration-framework. –û–ø–µ—Ä–∏—Ä—É–µ—Ç changelog'–∞–º–∏ - —Å–∫—Ä–∏–ø—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∏–∑–º–µ–Ω–µ–Ω–∏—è.

## 73. Liquidbase II
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **LiquidBaseAutoConfiguration**.

*TODO: –ü—Ä–∏–º–µ—Ä.*

## 74. Web-Starter. –í–≤–µ–¥–µ–Ω–∏–µ
–ú–æ–¥—É–ª—å Spring-MVC: –í –Ω—ë–º —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–∞—Ç—Ç–µ—Ä–Ω FrontController. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–ª–µ—Ç - Dispatcher Servlet: –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—á–µ—Ä–µ–∑ –Ω–µ–≥–æ, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—è –∏—Ö –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –ø–æ —Å–æ–æ—Ç–≤. URL.

–í Spring Boot –µ—Å—Ç—å Embedded Tomcat: Catalina Servlet Container –∏ Coyote HTTP Connecter.

–ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ starter-web –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Ç–æ–∫ (–Ω–µ –¥–µ–º–æ–Ω) => –Ω–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

–û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - **WebMvcAutoConfiguration**. –í –Ω—ë–º **DispatcherServletAutoConfiguration**. –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω—É—Ç—Ä–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è **ServletWebServerFactoryAutoConfuiguration**.

## 75. Dispatcher Servlet
–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª:
HTTP –∑–∞–ø—Ä–æ—Å –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç Coyote, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ –∫–ª–∞—Å—Å Request. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å –ø–æ–ø–∞–¥–∞–µ—Ç –≤ Catalina. –¢–∞–∫ –∫–∞–∫ —Å–µ—Ä–≤–ª–µ—Ç –æ–¥–∏–Ω, –æ–Ω –µ–¥–∏–Ω–æ–∂–¥—ã –ø—Ä–æ–π–¥–µ—Ç –ñ–¶:
1. - Load Servlet class
   - New Servlet Instance
   - invoke servlet.init()
2. - invoke servlet.service(req, resp)
3. - invoke servlet.destroy()

–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø–µ—Ä–µ—Ö–æ–¥—è—Ç –Ω–∞ –º–µ—Ç–æ–¥ **servlet.service()**: –ü–æ URL –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ == –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä. –¢–∞–∫–∂–µ –≤ –æ–±—Ä–∞—Ç–∞–±–æ—Ç—á–∏–∫–µ –µ—Å—Ç—å Interceptor'—ã == —Ñ–∏–ª—å—Ç—Ä—ã. –ü–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è handler'–∞, –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è **HandlerAdapter** (–≤ –Ω—ë–º –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ –Ω–∞ **WebApplicationContext**). **HandlerAdapter** –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è:
- **HandlerMethodArgumentResolver**'—ã - –Ω—É–∂–Ω—ã –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, —á—Ç–æ –∑–∞–∏–Ω–∂–µ–∫—Ç–∞—Ç—å –≤ –≤–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä.
- **HandlerMethodReturnValueHandler**'—ã - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.

–î–∞–ª–µ–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
```java
ModelAndView mv = handlerAdaper.handle(req, resp, handle);
```

–í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ **ModelAndView** - –º–æ–¥–µ–ª—å (–¥–∞–Ω–Ω—ã–µ) –∏ view. –ù–æ —á–∞—Å—Ç–æ –æ–Ω null, —Ç–∞–∫ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è REST. –î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **@ResponseBody** == –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –µ—Å—Ç—å. –ò–Ω–∞—á–µ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è view.

–î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ exception'–æ–≤ –µ—Å—Ç—å **handlerExceptionResolver**.

```java
try {
    HandlerExecutionChain handler = getHandler(req);
    HandlerAdapter handlerAdapter = getHandlerAdapter(handler);
    ModelAndView mv = handlerAdapter.handle(req, resp, handler);
    if (mv != null) {
        View view = viewResolvers.resolveView(mv.getViewName());
        view.render(mv.getModel());
    }
} catch (Exception ex) {
    handlerExceptionResolves.resolveException(ex);
}
```

–í **DispatcherSerlvet** –µ—Å—Ç—å –º–µ—Ç–æ–¥ **doDispatch()** –≤ –∫–æ—Ç–æ—Ä–æ–º —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤—ã—à–µ–æ–ø–∏—Å–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞.

## 76. Controller
–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è jasper'–∞ tomcat-embedded-jasper.

–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ view-resolver:
```yaml
mvc:
  view:
    prefix: /WEB-INF/jsp/
    suffix: .jsp
```

- webapp
  - WEB-INF
    - jsp
      - greeting
        - bye.jsp
        - hello.jsp

–ê–Ω–Ω–æ—Ç—Ü–∏—è **@Controller** - —ç—Ç–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç.

–ü—Ä–∏–º–µ—Ä:
```java
@Controller
public class GreetingController {

    public ModelAndView hello(ModelAndView modelAndView, HttpServletRequest request, CompanyRepository companyRepository) {
        modelAndView.setViewName("greeting/hello");

        return modelAndView;
    }

    public ModelAndView bye() {
        ModelAndView modelAndView = new ModelAndView();
        modelAndView.setViewName("greeting/bye");

        return modelAndView;
    }
}
```

–í–º–µ—Å—Ç–æ new –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DI. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–¥–µ–ª–∞—Ç—å **HandlerMethodArgumentResolver**.

–û—Å—Ç–∞–ª–æ—Å—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥–∞–º URL path.

## 77. RequestMapping
–ü–∞–º—è—Ç–∫–∞ –æ–± HTTP-—Å–æ–æ–±—â–µ–Ω–∏—è—Ö:
–°—Ç–∞—Ä—Ç–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞, headers –∏ body.

–í —Ä–µ–∫–≤–µ—Å—Ç–µ: –ú–µ—Ç–æ–¥, url, –≤–µ—Ä—Å–∏—è HTTP.
–ú–µ—Ç–æ–¥—ã:
- **GET** - –∑–∞–ø—Ä–æ—Å –Ω–∞ —á—Ç–µ–Ω–∏–µ
- **POST** - —Å–æ–∑–¥–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- **PUT** - –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–Ω–æ—Å—Ç—å
- **DELETE** - —É–¥–∞–ª–∏—Ç—å —Å—É—â–Ω–æ—Å—Ç—å
- **PATCH** - —á–∞—Å—Ç–∏—á–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–Ω–æ—Å—Ç—å

–í —Ä–µ—Å–ø–æ–Ω—Å–µ: –≤–µ—Ä—Å–∏—è, —Å—Ç–∞—Ç—É—Å, –ª–µ–π–±–ª.
–°—Ç–∞—Ç—É—Å—ã:
- **1—Ö—Ö - INFORMATIONAL**
- **2—Ö—Ö - SUCCESS**
- **3—Ö—Ö - REDIRECTIONAL**
- **4—Ö—Ö - CLIENT ERROR**
- **5—Ö—Ö - SERVER ERROR**

–í —Å–ª—É—á–∞–µ **GET** –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏–Ω—è—Ç–æ –¥–µ—Ä–∂–∞—Ç—å body –ø—É—Å—Ç—ã–º.

–ö—Ä–æ–º–µ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏, header, –∏ body, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—â–µ –∏ **cookie**: —É—Å—Ç–∞–Ω–∞–≤–∏–ª–≤–∞—é—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º, —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞. –î–ª—è —ç—Ç–æ–≥–æ –≤ —Ä–µ—Å–ø–æ–Ω—Å–µ —Å–ª–µ–¥—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ **set-cookie**. –í —Ä–µ–∫–≤–µ—Å—Ç–µ –≤—Å–µ –∫—É–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—é—Ç—Å—è –≤ –ø–∞—Ä—ã –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º **Cookie**.

URL —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:
–ø—Ä–æ—Ç–æ–∫–æ–ª, –¥–æ–º–µ–Ω (—Ö–æ—Å—Ç + –ø–æ—Ä—Ç), –ø—É—Ç—å, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (—á–µ—Ä–µ–∑ ?, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ &), —Ñ—Ä–∞–≥–º–µ–Ω—Ç (—á–µ—Ä–µ–∑ #).

–î–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ –º–µ—Ç–æ–¥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **@RequestMapping**:
- value() / path() - –ú–æ–∂–Ω–æ –º–∞—Å—Å–∏–≤.
- method()
- params()
- headers()
- consumes() - –ø—Ä–∏–Ω–∏–º–∞–µ–º—ã–π content-type
- produces() - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–π content-type

–ê–Ω–∞–ª–æ–≥–∏:
- **@GetMapping**
- **@PostMapping**

**@RequestMapping** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±—â–µ–≥–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞ path. –°—Ç–∞–≤–∏—Ç—Å—è –Ω–∞–¥ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º.

–ü—Ä–∏–º–µ—Ä:
```java
@GetMapping("/hello")
```

## 78. Parametrs, Headers, Cookies
### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
–í —Å–µ—Ä–≤–ª–µ—Ç–∞—Ö –æ–Ω–∏ –∏–∑–≤–ª–µ–∫–∞–ª–∏—Å—å –∏–∑ HttpSerletRequest –º–µ—Ç–æ–¥–æ–º getParameter():
```java
String ageParamValue = request.getParameter("age");
```

String –±—ã–ª–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ç—å –≤ –Ω—É–∂–Ω—ã–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö. –°–æ Spring'–æ–º –∑–∞–¥–∞—á–∞ —É–ø—Ä–æ—â–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ **@RequestParam**:
```java
public ModelAndView hello(ModelAndView modelAndView
                            HttpServletRequest request
                            @RequestParam("age") Integer age) {
    modelAndView.setViewName("greeting/hello");

    return modelAndView;
}
```

–í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –ø–∞—Ä–∞–º–µ—Ç—Ä –±—É–¥–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º, –µ—Å–ª–∏ –Ω–µ –ø–æ—Å—Ç–∞–≤–∏—Ç—å **required=false**.

### –ó–∞–≥–æ–ª–æ–≤–∫–∏
–í —Å–µ—Ä–≤–ª–µ—Ç–∞—Ö: **request.getHeader("accept")**. –í Spring'–µ **@RequestHeader("accept") String accept**.

### Cookie
–í —Å–µ—Ä–≤–ª–µ—Ç–∞—Ö: **Cookie[] cookies = request.getCookies()**;
–í Spring: **@CookieValue("JSESSIONID") String jsessionId**

–ú–æ–∂–Ω–æ –æ–ø—É—Å–∫–∞—Ç—å value, –µ—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –º–µ—Ç–æ–¥–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç.

### Path Variable
```java
@GetMapping("/hello/{id}")
public ModelAndView hello(..., @PathVariable("id") Integer id)
```

## 79. Model
–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤–æ view, –∫–∞–∫ —Ä–∞–∑ –Ω—É–∂–Ω–∞ –º–æ–¥–µ–ª—å.

–í —Å–µ—Ä–≤–ª–µ—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å **Attributes - Map\<String, Object\>**

–ê—Ç—Ç—Ä–∏–±—É—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Å—Å–∏–∏ **HttpSession**, –∞ —Ç–∞–∫–∂–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ä–µ–∫–≤–µ—Å—Ç–∞ **HttpServletRequest**.

–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞—Ç—Ç—Ä–∏–±—É—Ç–æ–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Å—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **@SessionAttribute** –∏ **@SessionAttributes**. –û—Ç–ª–∏—á–∏–µ: –≤ **@SessionAttribute** –∞—Ç—Ç—Ä–∏–±—É—Ç –¥–æ—Å—Ç–∞—ë—Ç—Å—è –∏–∑ —Å–µ—Å—Å–∏–∏, –∞ –≤ **@SessionAttributes** –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è, –∫–∞–∫ –∞—Ç—Ç—Ä–∏–±—É—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Å–µ—Å—Å–∏–∏, –∞ –Ω–µ –≤ —Ä–µ–∫–≤–µ—Å—Ç–µ.

**@RequestAttribute** - –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ä–µ–∫–≤–µ—Ç–∞. –í—Å–µ –∞—Ç—Ç—Ä–∏–±—É—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —è–≤–ª—è—é—Ç—Å—è default.

**modelAndView.addObject()** - –¥–æ–±–∞–≤–ª—è–µ—Ç –∞—Ç—Ç—Ä–∏–±—É—Ç—ã.

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞—Ç—Ç—Ä–∏–±—É—Ç –±—É–¥–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ä–µ–∫–≤–µ—Å—Ç–∞ == requestScope.

–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Å—Å–∏–æ–Ω–Ω–æ–≥–æ –∞—Ç—Ç—Ä–∏–±—É—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –º–µ—Ç–æ–¥ **request.getSession().setAttribute()**. –í Spring - –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è –Ω–∞–¥ –º–µ—Ç–æ–¥–æ–º **@SessionAttribute({"user"})**.

```java
@Controller
@RequestMapping("/api/v1")
@SessionAttributes({"user"})
public class GreetingController {

    @GetMapping("/hello")
    public ModelAndView hello(ModelAndView modelAndView, HttpServletRequest request) {
//        request.getSession().setAttribute(); sessionScope
//        request.setAttribute(); requestScope
//        request.getSession().getAttribute("user")
        modelAndView.setViewName("greeting/hello");
        modelAndView.addObject("user", new UserReadDto(1L, "Ivan"));

        return modelAndView;
    }

    @GetMapping("/bye")
    public ModelAndView bye(@SessionAttribute("user") UserReadDto user) {
//        request.getSession().getAttribute("user")
        ModelAndView modelAndView = new ModelAndView();
        modelAndView.setViewName("greeting/bye");

        return modelAndView;
    }
}
```

## 80. ModelAttributes
–í–º–µ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è ModelAndView –º–æ–∂–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å **String**! **ReturnValueHandler** –≤—Å–µ —Å–¥–µ–ª–∞–µ—Ç —Å–∞–º. –ü—Ä–∏—á–µ–º –º–æ–∂–Ω–æ –∏–Ω–∂–µ–∫—Ç–∞—Ç—å **Model** –≤–º–µ—Å—Ç–æ **ModelAndView**. –£ **Model** –µ—Å—Ç—å –º–µ—Ç–æ–¥ **addAttribute()**.

Spring –º–æ–∂–µ—Ç —Å–∞–º —Å–æ–∑–¥–∞–≤–∞—Ç—å –∞—Ç—Ç—Ä–∏–±—É—Ç—ã. –î–ª—è —ç—Ç–æ–≥–æ –∏–Ω–∂–µ–∫—Ç–∞–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç, –∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ HTTP. Spring —Å–º–∞–ø–∏—Ç –≤—Å—ë —Å–∞–º.

–ü—Ä–∏–º–µ—Ä:
```java
//localhost:8080/api/v1/hello?id=11&username=Petr

 @GetMapping("/hello")
public String hello(Model model,
                    HttpServletRequest request,
                    UserReadDto userReadDto) {
}
```

–í **userReadDto** –±—É–¥—É—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è.

–ù–µ—è–≤–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è **@ModelAttribute** –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–µ –º–µ—Ç–æ–¥–∞ –ø–µ—Ä–µ–¥ **UserReadDto userReadDto**.

–ï—ë –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å –Ω–∞–¥ –º–µ—Ç–æ–¥–æ–º, —á—Ç–æ–±—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª—è–ª–æ—Å—å –≤ –º–æ–¥–µ–ª—å –∫–∞–∫ –∞—Ç—Ç—Ä–∏–±—É—Ç. –ü—Ä–∞–≤–¥–∞, —Ç–∞–∫–æ–π –º–µ—Ç–æ–¥ –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ —Ä–µ–∫–≤–µ—Å—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ **Model**.

–¢–∞–∫–∂–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ jsp-—Ñ–æ—Ä–º–µ.

## 81. Forward, Include, Redirect
–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ - Forward, Include, Redirect. Forward –∏ Include –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ Tomcat —Å —Å–µ—Ä–≤–ª–µ—Ç–∞–º–∏ –∏ jsp. **Redirect –±–æ–ª–µ–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª–µ–Ω –∏ –ø—Ä–∏–Ω—è—Ç –≤ HTTP**.

- **Forward** –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å —Å –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–ª–µ—Ç–∞ –Ω–∞ –¥—Ä—É–≥–æ–π. 
- **Include** –¥–µ–ª–∞–µ—Ç —Ç–æ–∂–µ —Å–∞–º–æ–µ, –Ω–æ –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π —Å–µ—Ä–≤–ª–µ—Ç. 
- **Redirect** –≤—ã–∑—ã–≤–∞–µ—Ç —É response –º–µ—Ç–æ–¥ sendRedirect("url"), –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ—Å–ø–æ–Ω—Å —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 302, –∞ –∫–ª–∏–µ–Ω—Ç –¥–µ–ª–∞–µ—Ç –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å –Ω–æ–≤—ã–º URL.

–ü—Ä–∏–º–µ—Ä:
```java
@PostMapping("/login")
public String login(Model model, @ModelAttribute("login") LoginDto loginDto) {
//        return "forward:/WEB-INF/jsp/user/login.jsp";
//        return "redirect:https://google.com";
    return "redirect:/login";
}
```

## 82. CRUD. API Design
Best paractice —Å [RESTful API Design. Best Practices in a Nutshell:
](https://phauer.com/2015/restful-api-design-best-practices/)

### Use Two URLs per Resource
One URL for the collection and one for a single resource:
```
# URL that represents a collection of resources
/employees          
# URL that represents a single resource
/employees/56       
```

### Use Consistently Plural Nouns
–õ—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ.

### Use HTTP Methods to Operate on your Resources 
Use URLs to specify the resources you want to work with. Use the HTTP methods to specify what to do with this resource. With the five HTTP methods GET, POST, PUT, PATCH and DELETE you can provide CRUD functionality (Create, Read, Update, Delete) and beyond.

### Understand the Semantics of the HTTP Methods 
Definition of Idempotence: A HTTP methods is idempotent when we can safely execute the request over and over again and all requests lead to the same state.

- GET
  - Idempotent
  - Read-only. GET never changes the state of the resource on the server-side. It must not have side-effects. 
  - Hence, the response can be cached safely.
  - Examples:
    - GET /employees - Lists all employees
    - GET /employees/1 - Shows the details of the employee 1
- PUT
  - Idempotent!
  - Can be used for both creating and updating
  - Commonly used for updating (full updates).
    - Example: PUT /employees/1 - updates employee 1 (uncommon: creates employee 1)
  - To use PUT for creating, the client needs to know the whole URL (including the ID) upfront. That‚Äôs uncommon as the server usually generates the ID. So PUT for creating is typically used when there is only one element and the URL is unambiguous.
    - Example: PUT /employees/1/avatar - creates or updates the avatar of employee 1. There is only one avatar for each employee.
  - Always include the whole payload in the request. It‚Äôs all or nothing. PUT is not meant to be used for partial updates (see PATCH).
- POST
  - Not idempotent!
  - Used for creating
  - Example: POST /employees creates a new employee. The new URL is delivered back to the client in the Location Header (e.g. Location: /employees/12). Multiple POST requests on /employees lead to many new different employees (that‚Äôs why POST is not idempotent).
- PATCH
  - Idempotent
  - Used for partial updates.
  - Example: PATCH /employees/1 - updates employee 1 with the fields contained in the payload. The other fields of employee 1 are not changed.
- DELETE
  - Idempotent
  - Used for deletion.
  - Example: DELETE /employees/1

### POST on the Resource Collection URL to Create a New Resource
1. The client sends a POST request to the resource collection URL /employees. The HTTP body contains the attributes of the new resource ‚ÄúPaul‚Äù.
2. The RESTful web service generates an ID for the new employee, creates the employee in its internal model and sends a response to the client. **This response contains the status code 201 (Created) and a Location HTTP header that indicates the URL under which the created resource is accessible**.

### PUT on the Single Resource URL for Updating a Resource
1. The client sends a PUT request to the single resource URL /employee/21. The HTTP body of the PUT request contains all fields of the employee and every field will be updated on the server-side.
2. The REST service updates the name and status of the employee with the ID 21 and confirms the changes with the HTTP status code 200.

### Wrap the Actual Data in a data Field
GET /employees returns a list of objects in the data field:
```json
{
  "data": [
    { "id": 1, "name": "Larry" }
    , { "id": 2, "name": "Peter" }
  ]
}
```

### Use the Query String (?) for Optional and Complex Parameters
```
GET /employees?state=internal&title=senior
GET /employees?id=1,2
```

–ü—Ä–∏–º–µ—Ä (–¢.–∫. –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è jsp, –∞ –Ω–µ RestController'—ã, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –º–æ–º–µ–Ω—Ç—ã —Å–æ—É-—Å–æ—É):
```java
@Controller
@RequestMapping("/users")
@RequiredArgsConstructor
public class UserController {

    private final UserService userService;

    @GetMapping
    public String findAll(Model model) {
//        model.addAttribute("users", userService.findAll());
//        model.addAttribute("users", userService.findAll(filter));
        return "user/users";
    }

    @GetMapping("/{id}")
    public String findById(@PathVariable("id") Long id, Model model) {
//        model.addAttribute("user", userService.findById(id));
        return "user/user";
    }

    @PostMapping
    public String create(@ModelAttribute UserCreateEditDto user) {
//        userService.create(user);
        return "redirect:/users/" + 25;
    }

//    @PutMapping("/{id}")
    @PostMapping("/{id}/update")
    public String update(@PathVariable("id") Long id, @ModelAttribute UserCreateEditDto user) {
//        userService.update(id, user);
        return "redirect:/users/{id}";
    }

//    @DeleteMapping("/{id}")
    @PostMapping("/{id}/delete")
    public String delete(@PathVariable("id") Long id) {
//        userService.delete(id);
        return "redirect:/users";
    }
}
```

## 83. CRUD Service Layer
–ù–µ –∑–∞–±—ã–≤–∞—Ç—å –±—Ä–æ—Å–∞—Ç—å **ResponseStatusException(HttpStatus.NOT_FOUND)**!

**@GetMapping** –º–æ–∂–Ω–æ –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞!

–í –º—ç–ø–ø–µ—Ä–∞—Ö –Ω–æ—Ä–º–∞–ª—å–Ω–æ –∏–Ω–∂–µ–∫—Ç–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.

–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –µ—Å—Ç—å **@ResonseStatus**.

–ù–∞–¥ —Å–µ—Ä–≤–∏—Å–æ–º –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å **@Transactional(readOnly = true)** (–ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î –∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è - Hibernate –Ω–µ –±—É–¥–µ—Ç –¥–µ–ª–∞—Ç—å **session.flush()**, —Ç–∞–∫ –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è), –∞ –Ω–∞–¥ –º–µ—Ç–æ–¥–æ–º, –∏–∑–º–µ–Ω—è—é—â–∏–º —Å—É—â–Ω–æ—Å—Ç—å, —É–∂–µ —Å—Ç–∞–≤–∏—Ç—å **@Transactional** –±–µ–∑ readOnly. 

–°—Ç–æ–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **saveAndFlush()** –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏!

## 84. Spring MVC Testing
**@MockMvc** –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å HTTP-–∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ –æ–±—ä–µ–∫—Ç **MockMvc**.

–í–º–µ—Å—Ç–µ —Å –Ω–∏–º –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º—ç—Ç—á–µ—Ä—ã:
```java
@AutoConfigureMockMvc
@RequiredArgsConstructor
class UserControllerTest extends IntegrationTestBase {

    private final MockMvc mockMvc;

    @Test
    void findAll() throws Exception {
        mockMvc.perform(get("/users"))
                .andExpect(status().is2xxSuccessful())
                .andExpect(view().name("user/users"))
                .andExpect(model().attributeExists("users"))
                .andExpect(model().attribute("users", hasSize(5)));
    }
}
```

–ï—Å–ª–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ –∏ –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–∞—Ö, –Ω—É–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å open-in-view: false, —Ç–æ–≥–¥–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±—É–¥—É—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–∏—Å–æ–≤. (?)

**queryParam()** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ —Å—Ç—Ä–æ–∫–µ –∑–∞–ø—Ä–æ—Å–∞, –∞ –µ—Å–ª–∏ –æ–Ω–∏ –≤ —Ç–µ–ª–µ, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **param()**:
```java
@Test
void create() throws Exception {
    mockMvc.perform(post("/users")
                    .param(username, "test@gmail.com")
                    .param(firstname, "Test")
                    .param(lastname, "TestTest")
                    .param(role, "ADMIN")
                    .param(companyId, "1")
//                        .param(birthDate, "2000-01-01")
            )
            .andExpectAll(
                    status().is3xxRedirection(),
                    redirectedUrlPattern("/users/{\\d+}")
            );
}
```

–í Lombok –µ—Å—Ç—å **@FieldNameConstants**, —á—Ç–æ–±—ã –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –ø–æ–ª–µ–π!

–î–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å {}!

–í —Å–ª—É—á–∞–µ –¥–∞—Ç –Ω—É–∂–µ–Ω –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä!

## 85. Type Converters
1. –í application.yaml –µ—Å—Ç—å –ø—Ä–æ–ø–µ—Ä—Ç—è format:
```yaml
spring:
  mvc:
    format:
      date: iso
```

2. –î–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—è –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é **@DateTimeFormat(pattern = "yyyy-MM-dd")**.

3. –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å **@Configuration**-–∫–ª–∞—Å—Å, –∏–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä—É—é—â–∏–π **WebMvcConfigurer**, –∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å addFormatters():
```java
@Configuration
public class WebConfiguration implements WebMvcConfigurer {

    @Override
    public void addFormatters(FormatterRegistry registry) {
        registry.addConverter(Jsr310Converters.StringToLocalDateConverter.INSTANCE);
    }
}
```

–†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –∫–æ–Ω–≤–µ—Ä—Ç–æ—Ä–∞–º–∏ –∏ —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä–∞–º–∏: —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä—ã –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –∏–Ω—Ç–µ—Ä–Ω–∞–ª–∏–∑–∞—Ü–∏–∏.

## 86. thymeleaf-starter
–ù–∞—Ñ–∏–≥.

## 87. CRUD. View Layer I
–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ.

## 88. CRUD. View Layer II
üòà

## 89. Filter Query
–≠—Ç–æ —Ç–æ–∂–µ –ø—Ä–æ thymeleaf üòø

## 90. Pagination. Best practices
–û–±–æ—Ä–∞—á–∏–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ JSON'–µ data, —á—Ç–æ–±—ã –±—ã–ª–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–∞–∫–∂–µ –∫–∞–∫—É—é-—Ç–æ –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–∞–≥–∏–Ω–∞—Ü–∏—é.

–ï—Å—Ç—å –¥–≤–∞ –≤–∞—Ä–∏–Ω–∞—Ç–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏:
- **Offset-based Pagination** - —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –ø—Ä–æ—â–µ, –Ω–æ –∏–º–µ–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é. –ü–µ—Ä–µ–¥–∞–µ–º offset –∏ limit.
- **Keyset-based Pagination** - –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è limit, –∏ –∫–ª—é—á, –Ω–∞–ø—Ä–∏–º–µ—Ä, **timestamp (createdSince) —Å –ò–ù–î–ï–ö–°–û–ú**.

–ü—Ä–∏–º–µ—Ä Offset-based Pagination:
```java
@Value
public class PageResponse<T> {
    List<T> content;
    Metadata metadata;

    public static <T> PageResponse<T> of(Page<T> page) {
        var metadata = new Metadata(page.getNumber(), page.getSize(), page.getTotalElements());
        return new PageResponse<>(page.getContent(), metadata);
    }

    @Value
    public static class Metadata {
        int page;
        int size;
        long totalElements;
    }
}
```

```java
// UserService class:

public Page<UserReadDto> findAll(UserFilter filter, Pageable pageable) {
    var predicate = QPredicates.builder()
            .add(filter.firstname(), user.firstname::containsIgnoreCase)
            .add(filter.lastname(), user.lastname::containsIgnoreCase)
            .add(filter.birthDate(), user.birthDate::before)
            .build();

    return userRepository.findAll(predicate, pageable)
            .map(userReadMapper::map);
}
```

```java
// UserController class:

@GetMapping
public String findAll(Model model, UserFilter filter, Pageable pageable) {
    Page<UserReadDto> page = userService.findAll(filter, pageable);
    model.addAttribute("users", PageResponse.of(page));
    model.addAttribute("filter", filter);
    return "user/users";
}
```

## 91. validation-starter. –í–≤–µ–¥–µ–Ω–∏–µ
–ü–æ–¥–∫–ª—é—á–∏—Ç—å starter-validation. –ø—Ä–∏—á—ë–º —Ç—è–Ω–µ—Ç—Å—è hibernate-validator, –∞ –≤–Ω—É—Ç—Ä–∏ jakarta.validation-api == JSR330.

–ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏:
- Min, Max
- Email
- Future, FutureOrPresent, Pas, PastOrPresent - –∞–Ω–æ—Ç–∞—Ü–∏–∏ –¥–ª—è –¥–∞—Ç
- Patttern - –¥–ª—è regex
- Positive, PositiveOrZero
- Size - –¥–ª–∏–Ω–∞ —Å—Ç—Ä–æ–∫, —Ä–∞–∑–º–µ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–π
- NotBlank, NotEmpty - –¥–ª—è —Å—Ç—Ä–æ–∫
- ...

–°—Ç–∞–≤—è—Ç—Å—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –Ω–∞–¥ –ø–æ–ª—è–º–∏.

–î–ª—è –∑–∞–ø—É—Å–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–µ –º–µ—Ç–æ–¥–∞ —Å—Ç–∞–≤–∏—Ç—Å—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è **@Valid**.

–ß—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é **400 Bad Request**, –º–æ–∂–Ω–æ –∏–Ω–∂–µ–∫—Ç–∞—Ç—å –≤ –º–µ—Ç–æ–¥ BindingResult —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º–æ–≥–æ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –µ–≥–æ –º–µ—Ç–æ–¥ **getAllErrors()**.

## 92. Custom validator
–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:
- String message
- Class<?>[] groups
- Class<? extends Payload> payload

–¢–∞–∫–∂–µ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Å—Ç—Ä–µ–π–Ω—Ç - –∫–ª–∞—Å—Å, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏–π –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é.

–ü—Ä–∏–º–µ—Ä:
```java
@Constraint(validatedBy = UserInfoValidator.class)
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
public @interface UserInfo {

    String message() default "Firstname or lastname should be filled in";

    Class<?>[] groups() default { };

    Class<? extends Payload>[] payload() default { };
}

@Component
@RequiredArgsConstructor
public class UserInfoValidator implements ConstraintValidator<UserInfo, UserCreateEditDto> {

    // –ú–æ–∂–Ω–æ –∏–Ω–∂–µ–∫—Ç–∞—Ç—å, —Ç–∞–∫ –∫–∞–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç.
    private final CompanyRepository companyRepository;

    @Override
    public boolean isValid(UserCreateEditDto value, ConstraintValidatorContext context) {
        return hasText(value.getFirstname()) || hasText(value.getLastname());
    }
}
```

–ú–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å **@Validated** –Ω–∞–¥ –∫–æ–Ω—Ñ–∏–≥-–∫–ª–∞—Å—Å–æ–º!

–ì—Ä—É–ø–ø—ã **@Validated** - –≤—ã–±–æ—Ä –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–≤, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—â–∏—Ö –≥—Ä—É–ø–ø—ã.

## 93. ControllerAdvice - ExceptionHandler
–ß—Ç–æ–±—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—å–∑–æ–≤–∞—Ç—å BidndingResult, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ExcetionHandler'—ã.

–ü—Ä–∏–º–µ—Ä:
```java
@ExceptionHandler(Excetion.class)
public String handleExceptions(Exception excetion/*, –±–∏–Ω—ã */) {
    log.error("Failed to return response", exception);
    return "error/error500";
}
```

–ß—Ç–æ–±—ã –ø–æ–≤–µ–¥–µ–Ω–∏–µ –±—ã–ª–æ –≥–ª–æ–±–∞–ª—å–Ω—ã–º, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å —Å —Ö—ç–Ω–¥–ª–µ—Ä–∞–º–∏ –∏ –ø–æ–º–µ—Ç–∏—Ç—å –µ–≥–æ **@ControllerAdvice**.

–ì–æ—Ç–æ–≤—ã–π –∫–ª–∞—Å—Å - **ResponseEntityExceptionHandler**.

## 94. REST. –í–≤–µ–¥–µ–Ω–∏–µ
–ü—Ä–æ–±–ª–µ–º—ã –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤: (?)
- –¢–æ–ª—å–∫–æ GET –∏ POST
- –†–µ—Å–ø–æ–Ω—Å—ã —Ç–æ–ª—å–∫–æ HTML
- –†–µ–∫–≤–µ—Å—Ç—ã —Ç–æ–ª—å–∫–æ –∏–∑ –±—Ä–∞–∑—É–µ—Ä–∞

REpresntational State Transfer - –æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–¥–∞—á—É —Å–æ—Å—Ç–æ—è–Ω–∏—è.

–¢–µ–ø–µ—Ä—å
- –í—Å–µ –º–µ—Ç–æ–¥—ã
- –†–µ–∫–≤–µ—Å—Ç—ã –∏ —Ä–µ—Å–ø–æ–Ω—Å—ã –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º

REST-–∫–ª–∏–µ–Ω—Ç—ã:
- URL, HttpClient –∏–∑ java.net
- RestTemplate –∏ WebClient –∏–∑ Spring - –≤—Ç–æ—Ä–æ–π –∞—Å–∏–Ω—Ö.

–í –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞—Ö –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTP!

## 95. REST. –ü—Ä–∞–∫—Ç–∏–∫–∞
–ß—Ç–æ–±—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –µ—Å—Ç—å, ModelAndView –Ω—É–∂–Ω–æ —É—Å—Ç–Ω–∞–≤–æ–≤–∏—Ç—å –≤ null, –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–≤ –º–µ—Ç–æ–¥ c **@ResponseBody**.

–ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–µ—Ñ–∏–∫—Å **/api/v1**:
- api - —ç—Ç–æ REST
- v1 - –≤–µ—Ä—Å–∏—è

–î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è content-type'–æ–º, –≤ @GetMapping –µ—Å—Ç—å –º–µ—Ç–æ–¥—ã consumes –∏ produces:
```java
@GetMapping(produces = MediaType.APPLICATION_JSON_VALUE) // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é.
```

–î–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **@RequestBody** –≤–º–µ—Å—Ç–µ —Å **@PostMapping(consumes = ...)**.

–ù–µ –∑–∞–±—ã–≤–∞–µ–º –ø—Ä–æ **@ResponseStatus(NO_CONTENT)** –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —É–¥–∞–ª–µ–Ω–∏–∏.

–ê –≤–æ–æ–±—â–µ @ResponseBody –º–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞–¥ –∫–ª–∞—Å—Å–æ–º => **@ResponseBody** + **@Controller** == **@RestController**.

–ü—Ä–∏–º–µ—Ä:
```java
@RestController
@RequestMapping("/api/v1/users")
@RequiredArgsConstructor
public class UserRestController {

    private final UserService userService;

    @GetMapping(produces = MediaType.APPLICATION_JSON_VALUE)
    public PageResponse<UserReadDto> findAll(UserFilter filter, Pageable pageable) {
        Page<UserReadDto> page = userService.findAll(filter, pageable);
        return PageResponse.of(page);
    }

    @GetMapping("/{id}")
    public UserReadDto findById(@PathVariable("id") Long id) {
        return userService.findById(id)
                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND));
    }

    @PostMapping(consumes = MediaType.APPLICATION_JSON_VALUE)
    @ResponseStatus(HttpStatus.CREATED)
    public UserReadDto create(@Validated({Default.class, CreateAction.class}) @RequestBody UserCreateEditDto user) {
        return userService.create(user);
    }

    @PutMapping("/{id}")
    public UserReadDto update(@PathVariable("id") Long id,
                              @Validated({Default.class, UpdateAction.class}) @RequestBody UserCreateEditDto user) {
        return userService.update(id, user)
                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND));
    }

    @DeleteMapping("/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    public void delete(@PathVariable("id") Long id) {
        if (!userService.delete(id)) {
            throw new ResponseStatusException(HttpStatus.NOT_FOUND);
        }
    }
}

@RestControllerAdvice(basePackages = "com.dmdev.spring.http.rest")
public class RestControllerExceptionHandler extends ResponseEntityExceptionHandler {
}
```

## 96. Swagger. API docs
Postman - REST-–∫–ª–∏–µ–Ω—Ç. –£–¥–æ–±–Ω–µ–µ - Swagger.

–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è springdoc-open-api-ui:ver. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é (—Å—Ö–µ–º—É) –ø–æ REST. –û–Ω–∞ —Ä–µ–∞–ª–∑–æ–≤–∞–Ω–∞ –∫–∞–∫ starter => –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –≤ application.yaml.

**localhost:8080/v3/api-docs** - —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ –≤–∏–¥–µ JSON.

**localhost:8080/swagger-ui/index-html** - —Ç—É—Ç –≤—Å—ë —á—É–¥–æ.

–ï—Å—Ç—å –µ—â–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –¥–ª—è –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è.

## 97. Upload Image
–ø–æ—Ñ–∏–≥

## 98. Get Image
+–ø–æ—Ñ–∏–≥

## 99. security-starter
**–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** - –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏. –ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—É—Ç–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –∏–º –ª–æ–≥–∏–Ω–∞ –∏ –ø–∞—Ä–æ–ª—è —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –≤ –±–≤–∑–µ –¥–∞–Ω–Ω—ã—Ö.

**–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–º–æ—á–∏–π –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ —Å–æ–æ—Ç–≤–µ—Å—Ç–≤–∏–∏ —Å —Ä–∞–Ω–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π.

–í —Å–µ—Ä–≤–ª–µ—Ç–∞—Ö:
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ü–µ–ø–æ—á–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤, —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏—Ö –¥–æ –≤—ã–∑–æ–≤–∞ —Å–µ—Ä–≤–ª–µ—Ç–∞. –£ —Ñ–∏–ª—å—Ç—Ä–∞ –ñ–¶ **init()** -\> **doFilter()** -\> **destroy()**.

–í —Å–ø—Ä–∏–Ω–≥–µ —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã, —á—Ç–æ–±—ã —Ñ–∏–ª—å—Ç—Ä—ã —Å–ª–µ–¥–æ–≤–∞–ª–∏ –ñ–¶ –±–∏–Ω–æ–≤. –î–ª—è —ç—Ç–æ–≥–æ –±—ã–ª —Å–¥–µ–ª–∞–Ω **DeligatingFilterProxy**, –Ω–∞—Ö–æ–¥—è—â–∏–π—Å—è –≤ **FilterChain**. –í —Å–∞–º–æ–º **DeligatingFilterProxy** –Ω–∞—Ö–æ–¥–∏—Ç—Å—è **FilterChainProxy**, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç —Ü–µ–ø–æ—á–∫—É —Å–µ–∫—å—é—Ä–∏—Ç–∏ —Ñ–∏–ª—å—Ç—Ä—ã - **SecurityFilterChain**.

–ü–æ—Ä—è–¥–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤–∞–∂–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ —Ç–∏–ø–∞ fail-fast.

–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è - starter-security. –í–Ω—É—Ç—Ä–∏ config –∏ web.

–í **SecurityFilterAutoConfiguration** - **User** —Å –ø–∞—Ä–æ–ª–µ–º!!!

–û—Å–Ω–æ–≤–Ω–æ–π –±–∏–Ω - **DelegetingFilterProxyRegistrationBean**.

–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ **SecurityFilterChain**.

## 100. Authentication Architecture
### –ú–æ–¥–µ–ª—å:
–°–∞–º—ã–π –≥–ª–∞–≤–Ω—ã–π –æ–±—ä–µ–∫—Ç - **SecurityContext**, –∫–æ—Ç–æ—Ä—ã–π —è–≤–ª—è–µ—Ç—Å—è –æ–±—ë—Ä—Ç–∫–æ–π –Ω–∞–¥ –æ–±—ä–µ–∫—Ç–æ–º **Authetication**. –í–Ω—É—Ç—Ä–∏ **Authentication** –Ω–∞—Ö–æ–¥—è—Ç—Å—è 3 –æ–±—ä–µ–∫—Ç–∞:
- **Principal** - –æ–±—ä–µ–∫—Ç, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π **UserDetails** –∏ —Ö—Ä–∞–Ω—è—â–∏–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.
- **Credentials** - –æ–±—ã—á–Ω–æ –ø–∞—Ä–æ–ª—å, –∏ –æ–±—ã—á–Ω–æ —á–∏—Å—Ç–∏—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
- **Authorities** - –æ–±—ã—á–Ω–æ —Ä–æ–ª–∏, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–µ **GrantedAuthorites**.

–î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø –∫ **SecurityContext**, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç **SecurityContextHolder**, –≤ –∫–æ—Ç–æ—Ä–æ–º –∏–º–µ—é—Ç—Å—è —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤; –º. –±. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω **ThreadLocal**. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–µ–∫–≤–µ—Å—Ç–µ, –æ–±—Ä–∞—â–∞—Ç—å—Å—è —Å–ª–µ–¥—É–µ—Ç –∫ **SecurityContextHolder**: –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –º—ã –∫–ª–∞–¥–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω–∞—à ThreadLocal, –∞ –∫–æ–≥–¥–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ—Å–ø–æ–Ω—Å, —É–¥–∞–ª—è–µ–º –µ–≥–æ –æ—Ç—Ç—É–¥–∞.

### –õ–æ–≥–∏–∫–∞:
–°–æ–∑–¥–∞–Ω–∏–µ **Authentication** –æ–±—ä–µ–∫—Ç–∞ **authRequest**. –î–∞–ª–µ–µ —Å–æ–∑–¥–∞–µ–º **AuthenticationManager** –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ–º **authRequest**. –í–Ω—É—Ç—Ä–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ foreach –ø–æ Authentication Provider. –ü—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç DAO - —Å–≤–µ—Ä—è–µ–º—Å—è —Å –ë–î.

–°–µ—Å—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –∫—É–∫–∞–º **JSESSIONID**.

## 101. DaoAuthenticationProvider
**DaoAuthenticationProvider** —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ —Ç–∏–ø–∞ **UserDeatailsService**, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å. –í–Ω—É—Ç—Ä–∏ –º–µ—Ç–æ–¥ **UserDetails loadUserByUsername(String username)**. –¢–∞–º –ø–∞—Ä–æ–ª—å, —Ä–æ–ª–∏ –∏ —Ç. –ø. –°–∞–º–∞—è –ø—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - **User**. –í –Ω–µ–≥–æ –Ω–∞–¥–æ –ø–µ—Ä–µ–¥–∞—Ç—å **Authorities**.

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç–Ω–∫–æ–¥–µ—Ä –ø–∞—Ä–æ–ª–µ–π, –ø–æ—ç—Ç–æ–º—É –≤ –ë–î –∑–Ω–∞—á–µ–Ω–∏—è –≤—ã–≥–ª—è–¥—è—Ç –∫–∞–∫ '{*noop*}123'. **noop** - –Ω–µ—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è.

–†–æ–ª–∏ –¥–æ–ª–∂–Ω—ã –∏–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å **GrantedAuthority**.

**UserService** - **UserDetailsService**:
```java
@Override
public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
    return userRepository.findByUsername(username)
            .map(user -> new org.springframework.security.core.userdetails.User(
                    user.getUsername(),
                    user.getPassword(),
                    Collections.singleton(user.getRole())
            ))
            .orElseThrow(() -> new UsernameNotFoundException("Failed to retrieve user: " + username));
}
```

## 102. Form Login
–ï—Å—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –ª–æ–≥–∏–Ω–∞ –∏ –ª–æ–≥–∞—É—Ç–∞.

## 103. HTTP Basic Authentication
–ï—Å—Ç—å –¥—Ä—É–≥–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è **AuthenticationFilter** - Http Basic Authentication. –í –Ω–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –∑–∞–≥–æ–ª–æ–≤–æ–∫ 
```
Authentication = Basic base64(username:password)
```
**username:password** - —ç—Ç–æ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è, –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è base64 (—Å –¥–≤–æ–µ—Ç–æ—á–∏–µ–º!).

–í **SecurityConfiguration** –¥–æ–±–∞–≤–ª—è–µ–º:
```java
@Configuration
public class SecurityConfiguration extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .csrf().disable()
                .authorizeRequests().anyRequest().authenticated()
                .and()
                .httpBasic(Customizer.withDefaults());
                // .formLogin(login -> login
                //         .loginPage("/login")
                //         .defaultSuccessUrl("/users")
                //         .permitAll());
    }
}
```

–ë—Ä–∞—É–∑–µ—Ä –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –æ–∫–æ—à–∫–æ!!! –ê –µ—â–µ –±—Ä–∞—É–∑–µ—Ä –∫—ç—à–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç —Ö—ç–¥–µ—Ä :(

## 104. PasswordEncoder
–¢–∞–∫ –∫–∞–∫ –Ω–µ—Ç –±–∏–Ω–∞ PasswordEncoder, –Ω–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ –≤—Ä—É—á–Ω—É—é.
```java
@Bean
public PasswordEncoder passwordEncoder() {
    return PasswordEncoderFactories.createDelegatingPasswordEncoder();
}
```

–ü–∞—Ä–æ–ª–∏ –æ–±—ã—á–Ω–æ –æ–±–Ω–æ–≤–ª—è—é—Ç —Å –ø–æ–º–æ—â—å—é **PATCH**!

–í DTO —Ö—Ä–∞–Ω–∏–º RAW-–ø–∞—Ä–æ–ª—å, –∞ –≤ –º–∞–ø–ø–µ—Ä–µ —ç–Ω–∫–æ–¥–∏–º.

## 105. Logout
–ï—Å—Ç—å —Å–ø–µ—Ü. —Ñ–∏–ª—å—Ç—Ä **LogoutFilter**, –∫–æ—Ç–æ—Ä—ã–π —É–¥–∞–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–µ—Å—Å–∏–∏. –õ–æ–≥–∞—É—Ç –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ **POST**!

```java
@Override
protected void configure(HttpSecurity http) throws Exception {
    http
            .csrf().disable()
            .authorizeRequests().anyRequest().authenticated()
            .and()
//                .httpBasic(Customizer.withDefaults());
            .logout(logout -> logout
                    .logoutUrl("/logout")
                    .logoutSuccessUrl("/login")
                    .deleteCookies("JSESSIONID"))
            .formLogin(login -> login
                    .loginPage("/login")
                    .defaultSuccessUrl("/users")
                    .permitAll());
}
```

## 106. Authorization Architecture
**AuthorizationFilter** - –Ω—É–∂–µ–Ω –∂–¥—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞.

–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∏–ª—å—Ç—Ä –≤ **FilterChain** - **FilterSecurityInterceptor**. –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è - **AuthorizationFilter**.

**AuthorizationManager** - —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –º–µ—Ç–æ–¥–æ–º **check()**. –ï–ì–æ –∞—Ä–≥—É–º–µ–Ω—Ç - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –æ–±—ä–µ–∫—Ç, –¥–ª—è –∫–æ—Ç—Ä–æ–≥–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—Å—è –¥–æ—Å—Ç—É–ø. –¢–∞–∫–∂–µ –µ—Å—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –º–µ—Ç–æ–¥ **verify()**, —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∫–æ—Ç–æ—Ä–æ–≥–æ —è–≤–ª—è–µ—Ç—Å—è **AuthorizationDecision**. –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω, –±—Ä–æ—Å–∞–µ—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∏ 403–∏–π —Å—Ç–∞—Ç—É—Å. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ—Ñ—Ç–µ–ª—å –Ω–µ –ø—Ä–æ—à–µ–ª **–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é**, —Ç–æ 401-–∏–π.

–†–æ–ª–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—Å—è **AuthorityAuthorizationManager**.

JSR 250 - —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —Å–µ–∫—å—é—Ä–∏—Ç–∏.

–ï—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–π **AuthorizationManager**. –ò–Ω—Ç–µ—Ä–µ—Å—é—â–∞—è –Ω–∞—Å - **RequestMatcherDelegatingAuthorizationManager**, –∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∞—è, –µ—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø –ü–û –ü–£–¢–ò —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏ –¥–µ–ª–µ–≥–∏—Ä—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –¥—Ä—É–≥–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã. –í –Ω–µ–π –µ—Å—Ç—å –º–∞–ø–∏–Ω–≥ –ø—É—Ç–∏ –∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.

–í SecurityRequest –∑–∞–º–µ–Ω—è–µ–º –º–µ—Ç–æ–¥ authorizeRequest() –Ω–∞ authorizeHttpRequest():
```java
@Override
protected void configure(HttpSecurity http) throws Exception {
    http
            .csrf().disable()
            .authorizeHttpRequests(urlConfig -> urlConfig
                    .antMatchers("/login", "/users/registration", "/v3/api-docs/**", "/swagger-ui/**").permitAll()
                    .antMatchers("/users/{\\d+}/delete").hasAuthority(ADMIN.getAuthority())
                    .antMatchers("/admin/**").hasAuthority(ADMIN.getAuthority())
                    .anyRequest().authenticated()
            )
//                .httpBasic(Customizer.withDefaults());
            .logout(logout -> logout
                    .logoutUrl("/logout")
                    .logoutSuccessUrl("/login")
                    .deleteCookies("JSESSIONID"))
            .formLogin(login -> login
                    .loginPage("/login")
                    .defaultSuccessUrl("/users"));
}
```

–ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤–∞–∂–µ–Ω! –û–ù–∏ –±—É–¥—É—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—Å—è –ø–æ –ø–æ—Ä—è–¥–∫—É.

## 107. Method security
–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏ **AuthorizationManager** - **Post/PreAuthorizeAuthorizationManager**.

**@PreAuthorize** - –Ω–∞–¥ –º–µ—Ç–æ–¥ –∏ –Ω–∞–¥ –∫–ª–∞—Å—Å–æ–º. –í –Ω—ë–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SpEL => –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –±–∏–Ω–∞–º. –ù–æ —á–∞—â–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–µ—Ç–æ–¥—ã: (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å and, or...)
```java
@PreAuthorize("hasAuthority('ADMIN')")
```

–ê–Ω–∞–ª–æ–≥ - @PostAuthorize. –û—Ç–ª–∏—á–∏–µ –≤ —Ç–æ–º, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è returnObject.

–ß—Ç–æ–±—ã **@PreAuthorize** —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –Ω—É–∂–Ω–æ –Ω–∞–¥–æ –∫–æ–Ω—Ñ–∏–≥-–∫–ª–∞—Å—Å–æ–º –ø–æ—Å—Ç–∞–≤–∏—Ç—å **@EnableMethodSecurity**.

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –Ω–∞–¥ –º–µ—Ç–æ–¥–∞–º–∏ —Å–µ—Ä–≤–∏—Å–æ–≤!!! –¢—É—Ç –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è AOP-–ø—Ä–æ–∫—Å–∏.

–ï—Å—Ç—å **@Pre(Post)Filter**, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ—Å—è –Ω–∞–¥ –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–≤–æ–ª—è—é—Ç –æ—Ç—Ñ–∏–ª—Ç—Ä–æ–≤—ã–≤–∞—Ç—å –≤—Ö–æ–¥–Ω—ã–µ –∏–ª–∏ –≤—ã—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –ª–æ–≥–∏—á–µ—Å–∫–æ–º—É —É—Å–ª–æ–≤–∏—é —Å –ø–æ–º–æ—â—å—é SpEL:
```java
@PostFilter("filterObject.role.name().equals('ADMIN')")
@PostFilter("@companyService.findById(filterObject.company.id()).isPresent()")
public Page<UserReadDto> findAll(UserFilter filter, Pageable pageable) {
    var predicate = QPredicates.builder()
            .add(filter.firstname(), user.firstname::containsIgnoreCase)
            .add(filter.lastname(), user.lastname::containsIgnoreCase)
            .add(filter.birthDate(), user.birthDate::before)
            .build();

    return userRepository.findAll(predicate, pageable)
            .map(userReadMapper::map);
}

```

–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–µ–¥–∫–æ.

## 108. Access to authenticated user
–í –∫–æ–¥–µ –∏–Ω–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥—Å—è –≤—Ä—É—á–Ω—É—é –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –ù–∞–ø—Ä–∏–º–µ—Ä, –≤ –∞—É–¥–∏—Ç–µ, –∫—Ç–æ —á—ë –Ω–∞–¥–µ–ª–∞–ª;
```java
@EnableJpaAuditing
@EnableEnversRepositories(basePackageClasses = ApplicationRunner.class)
@Configuration
public class AuditConfiguration {

    @Bean
    public AuditorAware<String> auditorAware() {
        return () -> Optional.ofNullable(SecurityContextHolder.getContext().getAuthentication())
                .map(authentication -> (UserDetails) authentication.getPrincipal())
                .map(UserDetails::getUsername);
    }
```

–ë–æ–ª–µ–µ –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± - **@CurrentSecurityContext** –∏ **@AuthenticationPrincipal** (—á–∞—â–µ) —É –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –≤ –º–µ—Ç–æ–¥–µ.

## 109. CSRF-Filter
Cross Site Request Forgery.

–ë—Ä–∞—É–∑–µ—Ä –º–æ–∂–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∫—É–∫–∏ —Ç—É–¥–∞, –∫—É–¥–∞ –Ω–µ –Ω–∞–¥–æ. –ò JSESSIONID –º–æ–∂–µ—Ç –±—ã—Ç—å —É–∫—Ä–∞–¥–µ–Ω! –ö—É–∫–∏ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–≥—É –±—ã—Ç—å –æ–ø–∞—Å–Ω—ã.

–ï—Å—Ç—å –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ä–µ—à–µ–Ω–∏—è:
- Synchronizer Tokern Pattern (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Spring'–µ) - –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫.
- SameSite Attribute - –∫—É–∫–∞.

–ü–∞—Ä–∞–º–µ—Ç—Ä csrf - —Ç–æ–∫–µ–Ω, —Ö—Ä–∞–Ω—è—â–∏–π—Å—è –≤ —Å–µ—Å—Å–∏–∏ (–ø–æ —É–º–æ–ª—á.). –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —Ñ–æ—Ä–º–æ–π! => —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç —Ä–∞–∑–ª–∏—á–∏—Ç—å, –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–µ–ª –∑–∞–ø—Ä–æ—Å.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–¥—É–µ—Ç, —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä.

## 110. Security Testing
—Å–µ–∫—å—é—Ä–∏—Ç–∏ + —Ç–µ—Å—Ç—Ä–æ–≤–∞–Ω–∏–µ = –æ—á–µ–Ω—å –ª–µ–Ω—å

## 111. OAuth 2.0. –¢–µ–æ—Ä–∏—è
–ü—Ä–æ—Ç–æ–∫–æ–ª –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. Authorization server - —Å—Ç–æ—Ä–æ–Ω–Ω–∏–π —Å–µ—Ä–≤–µ—Ä —Å –¥–æ–≤–µ—Ä–∏–µ–º. –ú–æ–∂–µ—Ç –±—ã—Ç—å –ì—É–≥–ª, –ì–∏—Ç—Ö–∞–±... => –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –∫—Ä–µ–¥—ã.

–ù–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ - Auth Client. –°–µ—Ä–≤–µ—Ä –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç client_id –∏ client_secret.

OAuth 2 Flows:
- Authorization Code Flow - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —á–∞—â–µ –≤—Å–µ –Ω–∞ –±—ç–∫–µ–¥–Ω–µ
- Implicit Flow
- Hybrid Flow

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ Auth Server —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
- client_id - —é—Ö–µ—Ä–Ω–µ–π–º
- redirect_url
- scope
- response_type=code - –∫–∞–∫–æ–π —Ñ–ª–æ—É

–î–∞–ª–µ–µ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–æ—é —Ñ–æ—Ä–º—É —Å –∫—Ä–µ–¥–∞–º–∏. –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ª–æ–≥–∏–Ω–µ, —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ –¥–∞–ª–µ–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –∏—Å—Ö–æ–¥–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (–∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –ø–æ–ª—É—á–µ–Ω –≤–æ–Ω —Ç–∞–º ^) –ò –∫–æ–¥ (authorization code).

–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–¥, –∏ –∫–ª–∏–µ–Ω—Ç –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å —Å –∫–æ–¥–æ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∑–∞ —Ç–æ–∫–µ–Ω–∞–º–∏:
- access_token (authorities) - —Å—Ç—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä–∞—è —Ö—Ä–∞–Ω–∏—Ç –Ω–∞–±–æ—Ä —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–∏–∫–∞–∫–æ–π –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏!
- refresh_token (optional)

–í Implicit Flow —Ç–æ–∫–µ–Ω—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —Å—Ä–∞–∑—É –≤–º–µ—Å—Ç–æ –∫–æ–¥–∞ => –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Ö –¥–µ—Ä–∂–∏—Ç.

–í OAuth 2 –Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ! –ï—Å—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª-–Ω–∞–¥—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–¥ OAuth 2 - OpenID Connect (OIDC). –ï–≥–æ —Ñ–ª–æ—É —Ç–∞–∫–æ–π –∂–µ, –Ω–æ –∞—É—Ç-—Å–µ—Ä–≤–µ—Ä –≤—ã–¥–∞–∞–µ—Ç –µ—â–µ id_token —Å –¥–∞–Ω–Ω—ã–º–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–∑—Ä–µ—à–∏–ª –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —é–∑–µ—Ä. –í–∏–¥ - JWT. –í –Ω–µ–º –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–º—è, –ø–æ—á—Ç–∞, –ª–æ–∫–∞–ª—å...

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, OAuth 2 —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π, –∞ OIDC - –µ—â–µ –∏ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π.

–î–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è scope=openid.

## 112. OAuth 2.0.–ü—Ä–∞–∫—Ç–∏–∫–∞
- –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –Ω–∞ Google Cloud Platform
- Create credentials -> OAuth client ID -> configure -> external
- –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ credenials -> Create credentials -> ... -> –≤—ã–±–∏—Ä–∞–µ–º redirect uri

```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          google:
            clientId: 683078134097-228jgon9bc7ud9qfqkm3gam1k5b75pf8.apps.googleusercontent.com
            clientSecret: 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
            redirectUri: http://localhost:8080/login/oauth2/code/google
            scope: openid,email,profile
```

–¢–µ–ø–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ UserDetails, –∞ DefaultOidcUser. –í –Ω—ë–º –µ—Å—Ç—å —Ä–æ–ª–∏, –Ω–æ –Ω–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –¥–ª—è —Ä–∞–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö.

## 113. OAuth 2.0. Authentication Principle
–ù—É–∂–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏—Ç—å OAuth 2 —Å Authentication –æ–±—ä–µ–∫—Ç–æ–º.

–°–Ω–∞—á–∞–ª–∞ –Ω–∞–¥–æ –Ω—É–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å userInfoEndpoint:
```java
@Configuration
@EnableMethodSecurity
@RequiredArgsConstructor
public class SecurityConfiguration extends WebSecurityConfigurerAdapter {

    private final UserService userService;

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
//                .csrf().disable()
                .authorizeHttpRequests(urlConfig -> urlConfig
                        .antMatchers("/login", "/users/registration", "/v3/api-docs/**", "/swagger-ui/**").permitAll()
                        .antMatchers("/users/{\\d+}/delete").hasAuthority(ADMIN.getAuthority())
                        .antMatchers("/admin/**").hasAuthority(ADMIN.getAuthority())
                        .anyRequest().authenticated()
                )
//                .httpBasic(Customizer.withDefaults());
                .logout(logout -> logout
                        .logoutUrl("/logout")
                        .logoutSuccessUrl("/login")
                        .deleteCookies("JSESSIONID"))
                .formLogin(login -> login
                        .loginPage("/login")
                        .defaultSuccessUrl("/users"))
                .oauth2Login(config -> config
                        .loginPage("/login")
                        .defaultSuccessUrl("/users")
                        .userInfoEndpoint(userInfo -> userInfo.oidcUserService(oidcUserService()))
                );
    }

    private OAuth2UserService<OidcUserRequest, OidcUser> oidcUserService() {
        return userRequest -> {
            String email = userRequest.getIdToken().getClaim("email");
            // TODO: 24.04.2022 create user userService.create
            UserDetails userDetails = userService.loadUserByUsername(email);
//            new OidcUserService().loadUser()
            DefaultOidcUser oidcUser = new DefaultOidcUser(userDetails.getAuthorities(), userRequest.getIdToken());

            Set<Method> userDetailsMethods = Set.of(UserDetails.class.getMethods());

            return (OidcUser) Proxy.newProxyInstance(SecurityConfiguration.class.getClassLoader(),
                    new Class[]{UserDetails.class, OidcUser.class},
                    (proxy, method, args) -> userDetailsMethods.contains(method)
                            ? method.invoke(userDetails, args)
                            : method.invoke(oidcUser, args));
        };
    }
}
```

TODO: –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–æ—Å—ã –ø—Ä–æ –ø—Ä–æ–∫—Å–∏!

## 114. JWT. JSON Web Token
jwt.io –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω! 

–í —Ç–æ–∫–µ–Ω–µ (—Ä–∞–∑–¥–µ–ª–µ–Ω—ã —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É):
- –∑–∞–≥–æ–ª–æ–≤–æ–∫ - –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è 
- payload
- —Ü–∏—Ñ—Ä–æ–≤–∞—è –ø–æ–¥–ø–∏—Å—å - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å == –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è

–¢–æ–∫–µ–Ω –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ base64, –Ω–æ —Å—Ç–æ–∏—Ç –µ–≥–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —à–∏—Ñ—Ä–æ–≤–∞—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ–¥–∞–≤–∞—è –µ–≥–æ —á–µ—Ä–µ–∑ https!

## 115. Swagger Authorization
–ù—É–∂–Ω–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã —é–∑–∞—Ç—å —Å–≤–∞–≥–≥–µ—Ä :(

–ù–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ä–µ—à–µ–Ω–∏—è:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Http Basic - —Å–æ–≤–µ—Ç—É–µ—Ç—Å—è
- –°–¥–µ–ª–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ª–æ–≥–∏–Ω–∞ –≤ —Å–≤–∞–≥–≥–µ—Ä–µ - –Ω–µ—É–¥–æ–±–Ω–æ
- –ú–æ–∂–Ω–æ —á–µ—Ä–µ–∑ OAuth 2!

–î–ª—è OAuth 2:
```yaml
springdoc:
  swagger-ui:
    oauth:
      client-id: 683078134097-228jgon9bc7ud9qfqkm3gam1k5b75pf8.apps.googleusercontent.com
      client-secret: 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
      scopes: openid,email,profile
    oauth2-redirect-url: http://localhost:8080/swagger-ui/oauth2-redirect.html
```

```java
@Configuration
@SecurityScheme(
        name = "oauth2",
        type = SecuritySchemeType.OAUTH2,
        flows = @OAuthFlows(
                authorizationCode = @OAuthFlow(
                        authorizationUrl = "http://localhost:8080/oauth2/authorization/google",
                        tokenUrl = "https://www.googleapis.com/oauth2/v4/token"
                )
        )
)
public class OpenApiConfiguration {
}
```

## 116. i18n. MessageSource
–ò–Ω—Ç–µ—Ä–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø–æ–º–æ—â—å—é Spring!

–í —Å–µ—Ä–≤–ª–µ—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å ResourceBundle'—ã, —á—Ç–æ–±—ã –∏–∑–≤–ª–µ–∫–∞—Ç—å –∏–Ω—Ç–µ—Ä–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ –∫–ª—é—á–∞–º.

–í application.yml:
```yaml
spring:
  messages:
    basename: messages
```

–í messages.properties (–±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ - –¥–µ—Ñ–æ–ª—Ç):
```properties
login.username=Username
login.password=Password
```

–í messages_ru:
```properties
login.username=\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C
login.password=\u041F\u0430\u0440\u043E\u043B\u044C
```

–í –ò–¥–µ–µ –Ω–∞–¥–æ –∑–∞–π—Ç–∏ –≤ Editor -> File Encodings -> Properties Files: **UTF-8** –∏ –≥–∞–ª–æ—á–∫–∞ **Transperent native-to-ascii conversion**.

–ß—Ç–æ–±—ã –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è –¥–æ –±–∞–Ω–¥–ª–æ–≤:
```java
@RestController
@RequestMapping("/api/v1/messages")
@RequiredArgsConstructor
public class MessageRestController {

    private final MessageSource messageSource;

    @GetMapping
    public String getMessage(@RequestParam("key") String key,
                             @RequestParam("lang") String language) {
        return messageSource.getMessage(key, null, null, new Locale(language));
    }
}
```

## 117. i18n. Thymeleaf
–ù—É —ç—Ç–æ —Å–Ω–æ–≤–∞ –æ–Ω...

–¢–µ–º –Ω–µ –º–µ–Ω–µ–µ:
```java
@Configuration
public class WebConfiguration implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(localeChangeInterceptor());
    }

    @Override
    public void addFormatters(FormatterRegistry registry) {
//        registry.addConverter(Jsr310Converters.StringToLocalDateConverter.INSTANCE);
    }

    @Bean
    public LocaleResolver localeResolver() {
        var localeResolver = new CookieLocaleResolver();
        localeResolver.setDefaultLocale(Locale.US);
        return localeResolver;
    }

    @Bean
    public LocaleChangeInterceptor localeChangeInterceptor() {
        var interceptor = new LocaleChangeInterceptor();
        interceptor.setParamName("lang");
        return interceptor;
    }
}
```

## 118. AOP Starter
Crosscutting concerns - —Å–∫–≤–æ–∑–Ω–∞—è –ª–æ–≥–∏–∫–∞: –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∏—Å–∫–ª—é—á–µ–Ω–∏—è...

–¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è:
- **Aspect** - A modularization of a concern that cuts across multiple classes. –¢–∏–ø–∞ –∫–ª–∞—Å—Å –∏–∑ –û–û–ü.
- **Join point** - –¢–æ—á–∫–∞, –∫—É–¥–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Å–∫–≤–æ–∑–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª.
- **Advice** - –°–∞–º —Å–∫–≤–æ–∑–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª. –ú. –±.:
  - around
  - before
  - after
- **Pointuct** - –°—Ä–µ–∑. A predicate, that matches join points. Advice is associated with a pointcut expression and runs at any join point matched by the pointcut. –ü—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º - —Å—Ç–æ–∏—Ç –ª–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–∫–≤–æ–∑–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ç—É –∏–ª–∏ –∏–Ω—É—é join point.

–î–≤–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ê–û–ü –≤ Java:
- AspectJ - compile time. –ù–∏–∫–∞–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.
- Spring AOP - runtime —Å –ø–æ–º–æ—â—å—é –ø—Ä–æ–∫—Å–∏. –¢–æ–ª—å–∫–æ –≤ –°–ø—Ä–∏–Ω–≥-–±–∏–Ω–∞—Ö!

## 119. AOP. Pointcut
starter-data-jpa –∏ —Ç–∞–∫ —Ç—Ä–∞–Ω–∏–∑–∏—Ç–∏–≤–Ω–æ —Ç—è–Ω–µ—Ç –ê–û–ü-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å starter-aop. –í –Ω–µ–π —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è aspectj –∏ spring-aop.

–ß—Ç–æ–±—ã –∫–ª–∞—Å—Å —Å—Ç–∞–ª –∞—Å–ø–µ–∫—Ç–æ–º, –Ω—É–∂–Ω–æ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è aspectj @Aspect.

–í—Å–µ –∞—Å–ø–µ–∫—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –±–∏–Ω–∞–º–∏ -> @Component.

–î–ª—è –æ–ø–∏—Å–∞–Ω–∏—è pointcut'–æ–≤ –µ—Å—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å **Pointcut**, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π
- **ClassFilter getClassFilter()** - –∏–º–µ–µ—Ç –º–µ—Ç–æ–¥ **boolean matches(Class<?> clazz)**, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π —Å—Ç–æ–∏—Ç –ª–∏ –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Å–∞ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–∫–≤–æ–∑–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å.
- **MethodMatcher getMethodMatcher()** - —Ç–æ –∂–µ —Å–∞–º–æ–µ, —Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ—Ç–æ–¥–∞.

–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –µ—Å—Ç—å —Å–æ–æ—Ç–≤. –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏:
```java
@Pointcut()
public void isControllerLayer() {
}
```

–ê—Ä–≥—É–º–µ–Ω—Ç **@Pointcut**'–∞ - —á—Ç–æ-—Ç–æ —Ç–∏–ø–∞ —Ä–µ–≥. –≤—ã—Ä–∞–∂–µ–Ω–∏—è.
–ï—Å—Ç—å —Å–ª–µ–¥. –∫–ª—é—á —Å–ª–æ–≤–∞:
```java
@Aspect
@Component
public class FirstAspect {

    /*
        @within - check annotation on the class level
     */
    @Pointcut("@within(org.springframework.stereotype.Controller)")
    public void isControllerLayer() {
    }

    /*
        within - check class type name
     */
    @Pointcut("within(com.dmdev.spring.service.*Service)")
    public void isServiceLayer() {
    }

    /*
        this - check AOP proxy class type
        target - check target object class type
     */
    @Pointcut("this(org.springframework.data.repository.Repository)")
//    @Pointcut("target(org.springframework.data.repository.Repository)")
    public void isRepositoryLayer() {
    }

    /*
        @annotation - check annotation on method level
     */
    @Pointcut("isControllerLayer() && @annotation(org.springframework.web.bind.annotation.GetMapping)")
    public void hasGetMapping() {
    }

    /*
        args - check method param type
        * - any param type
        .. - 0+ any params type
     */
    @Pointcut("isControllerLayer() && args(org.springframework.ui.Model,..)")
    public void hasModelParam() {
    }

    /*
        @args - check annotation on the param type
        * - any param type
        .. - 0+ any params type
     */
    @Pointcut("isControllerLayer() && @args(com.dmdev.spring.validation.UserInfo,..)")
    public void hasUserInfoParamAnnotation() {
    }

    /*
        bean - check bean name
     */
    @Pointcut("bean(*Service)")
    public void isServiceLayerBean() {
    }

    /*
        execution(modifiers-pattern? ret-type-pattern declaring-type-pattern?name-pattern(param-pattern) throws-pattern?)
     */
    @Pointcut("execution(public * com.dmdev.spring.service.*Service.findById(*))")
    public void anyFindByIdServiceMethod() {
    }
}
```

**"isControllerLayer() && @annotation(org.springframework.web.bind.annotation.GetMapping)"** - —á—Ç–æ–±—ã –Ω–µ –∏—Å–∫–∞—Ç—å–≤—Å–µ –±–∏–Ω—ã.

## 120. AOP. _Before Advice
```java
@Before("anyFindByIdServiceMethod()")
// @Before("execution(public * com.dmdev.spring.service.*Service.findById(*))")
public void addLogging() {
    log.info("invoked findById method");
}
```

–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ–∫—Å–∏ –æ–±—ä–µ–∫—Ç **CglibAopProxy**, –æ–±—ë—Ä–Ω—É—Ç—ã–π –≤–æ–∫—Ä—É–≥ **UserService**. –¢–∞–∫–∂–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ Advice —Å–æ–∑–¥–∞—é—Ç—Å—è –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä—ã. –ù–æ–≤–∞—è —Å–∫–≤–æ–∑–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å == –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Å–µ–ø—Ç–æ—Ä.

–ü–æ—Ä—è–¥–æ–∫ advice'–æ–≤ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é **@Ordered**.

–í **AopAutoConfiguration** –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –≤–∏–¥ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è.

## 121. AOP. JoinPoint. Params
–†–µ–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç -> Advices -> AOP Cglib Proxy

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Å—Ç–∞, –∫—É–¥–∞ –±—ã–ª–∞ –≤–Ω–µ–¥—Ä–µ–Ω–∞ —Å–∫–≤–æ–∑–Ω–∞—è –ª–æ–≥–∏–∫–∞, –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ—Å–∏—Ç—å **JoinPoint**:
```java
public void addLogging(JoinPoint joinPoint)
```

–ê—Ä–≥—É–º–µ–Ω—Ç—ã –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å –ø–æ–º–æ—â—å—é **args**, –∫–∞–∫–∏–µ –∏ –¥—Ä—É–≥–∏–µ –æ—é—ä–µ–∫—Ç—ã:
```java
@Before(value = "anyFindByIdServiceMethod() " +
        "&& args(id) " +
        "&& target(service) " +
        "&& this(serviceProxy)" +
        "&& @within(transactional)",
        argNames = "joinPoint,id,service,serviceProxy,transactional")
// @Before("execution(public * com.dmdev.spring.service.*Service.findById(*))")
public void addLogging(JoinPoint joinPoint,
                        Object id,
                        Object service,
                        Object serviceProxy,
                        Transactional transactional) {
    log.info("invoked findById method in class {}, with id {}", service, id);
}
```

**argNames = "joinPoint,id,service,serviceProxy,transactional"** - –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –î–û JAVA 8.

**JointPoint** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–≤—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º, –µ—Å–ª–∏ –æ–Ω –Ω—É–∂–µ–Ω.

## 123. AOP. _After Advices
–ê–Ω–∞–ª–æ–≥ —Å try-catch-finally:
```java
@Before
try {
    methodCall()
    @AfterReturning
} catch (Exception e) {
    @AfterThrowing
} finally {
    @After
}
```

```java
@AfterReturning(value = "anyFindByIdServiceMethod() " +
        "&& target(service)",
        returning = "result")
public void addLoggingAfterReturning(Object result, Object service) {
    log.info("after returning - invoked findById method in class {}, result {}", service, result);
}

@AfterThrowing(value = "anyFindByIdServiceMethod() " +
        "&& target(service)",
        throwing = "ex")
public void addLoggingAfterThrowing(Throwable ex, Object service) {
    log.info("after throwing - invoked findById method in class {}, exception {}: {}", service, ex.getClass(), ex.getMessage());
}

@After("anyFindByIdServiceMethod() && target(service)")
public void addLoggingAfterFinally(Object service) {
    log.info("after (finally) - invoked findById method in class {}", service);
}
```

## 124. AOP. _Around Advice
–ü—Ä–∏–º–µ—Ä Around Advice - @Transactional.

```java
@Around("anyFindByIdServiceMethod() && target(service) && args(id)")
public Object addLoggingAround(ProceedingJoinPoint joinPoint, Object service, Object id) throws Throwable {
    log.info("AROUND before - invoked findById method in class {}, with id {}", service, id);
    try {
        Object result = joinPoint.proceed();
        log.info("AROUND after returning - invoked findById method in class {}, result {}", service, result);
        return result;
    } catch (Throwable ex) {
        log.info("AROUND after throwing - invoked findById method in class {}, exception {}: {}", service, ex.getClass(), ex.getMessage());
        throw ex;
    } finally {
        log.info("AROUND after (finally) - invoked findById method in class {}", service);
    }
}
```

## 125. AOP. Best Practices
–¢–∏–ø—ã –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–π Pointcut'–æ–≤:
- class level - —Ä–∞–±–æ—Ç–∞—é—Ç –æ—á–µ–Ω—å –∑–∞–≤—Ç—Ä–∞
    - within
    - @within
- target / this / args ... (—Ç–æ —á—Ç–æ –≤–Ω–µ–¥—Ä—è–µ—Ç—Å—è –≤ –º–µ—Ç–æ–¥—ã) - —Ä–∞–±–æ—Ç–∞—é—Ç –º–µ–¥–ª–µ–Ω–µ–µ –≤—Å–µ–≥–æ
- execution - method level

1. –•–æ—Ä–æ—à–∏–π Pointcut –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å class-level filter, execution –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ target / this / args ... –¢–æ–≥–¥–∞ —Å—Ä–µ–∑—ã –±—É–¥—É—Ç –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å—Å—è –æ—á–µ–Ω—å—å –±—ã—Å—Ç—Ä–æ.

2. –õ—É—á—à–µ –≤—ã–Ω–æ—Å–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ Pointcut'—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞—Å–ø–µ–∫—Ç:
```java
@Aspect
@Component
public class CommonPointcuts {

    /*
        @within - check annotation on the class level
     */
    @Pointcut("@within(org.springframework.stereotype.Controller)")
    public void isControllerLayer() {
    }

    /*
        within - check class type name
     */
    @Pointcut("within(com.dmdev.spring.service.*Service)")
    public void isServiceLayer() {
    }
}
```

3. –ò –¥–∞–ª—å—à–µ —Å—Å—ã–ª–∞—Ç—å—Å—è –ø–æ –ø–æ–ª–Ω–æ–º—É –∏–º–µ–Ω–∏ –∫–ª–∞—Å—Å–∞:
```java
@Pointcut("com.dmdev.spring.aop.CommonPointcuts.isControllerLayer() && @annotation(org.springframework.web.bind.annotation.GetMapping)")
public void hasGetMapping() {
}
```

4. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ Advice'—ã –ª—É—á—à–µ Around'–æ–≤.

5. –õ—É—á—à–µ —Ä–∞–∑–¥–µ–ª—è—Ç—å –∞—Å–ø–µ–∫—Ç—ã –ø–æ –ª–æ–≥–∏–∫–µ (–ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...) => –º–æ–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ—Ä—è–¥–∫–æ–º —á–µ—Ä–µ–∑ @Order.

## 126. Custom Spring Boot Starter
–ó–µ—Ç—Å –æ–ª–ª —Ñ–æ–ª–∫—Å!
